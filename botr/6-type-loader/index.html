<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.78e9442d5c9415ba4bfe.css" data-identity="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}@font-face{font-family:Source Code Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPevT.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7g.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlxdr.ttf) format("truetype")}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{font-family:Source Sans Pro,sans-serif}code,pre{font-family:Source Code Pro,monospace}html{font-size:100%;line-height:1.45;overflow-y:auto}body{color:#2f353f}div.mermaid,h1,h2,h3,h4,h5,h6,img,ol,p,ul{margin:0 0 24px}h4,h5{margin-bottom:1.0875rem}h1,h2,h3,h4,h5,h6{color:#2f353f;line-height:1.1}h1,h2,h3,h4,h6{font-weight:400}h1{font-size:2.5rem}h2{font-size:1.73286rem}h3{font-size:1.4427rem}h4{font-size:1.125rem;font-weight:700}h5,li,p{font-size:1rem}h6{font-size:.875rem}li,p{line-height:1.7}li li{font-size:1.05rem;line-height:1.4}ol,ul{margin-left:24px;padding:0}li{margin-bottom:12px}li>ol,li>ul{margin-top:12px}blockquote{border-left:2px solid #3f20ba;margin-left:0;padding:12px 20px}blockquote>ol,blockquote>p,blockquote>ul{font-size:inherit}blockquote>ol:last-child,blockquote>p:last-child,blockquote>ul:last-child{margin-bottom:0}blockquote li,td li{font-size:inherit;line-height:1.1}form{margin-bottom:0}hr{background-color:#dee2e7;border:none;height:1px;margin-bottom:23px}img.screenshot{border-radius:8px;box-shadow:0 0 0 1px rgba(18,21,26,.04),0 1px 4px 0 rgba(0,0,0,.08)}.gatsby-code-title{align-items:center;color:#5a6270;display:flex;font-family:Source Code Pro,monospace;font-size:15px;height:37px;margin-bottom:-37px;padding-left:19px}.gatsby-highlight-code-line{background-color:#ebeef0;display:block;margin-left:-3.5em;margin-right:-1em;padding-left:3.5em;padding-right:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.5em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows>span:before{color:#cad0d8}code[class*=language-],pre[class*=language-]{color:#2f353f;direction:ltr;font-family:Source Code Pro,monospace;font-size:15px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#f4f6f8;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{background:#ebeef0;border-radius:.3em;color:#f25cc1;font-size:.9em;padding:.1em .15em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#959daa}.token.punctuation{color:#5a6270}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#f25cc1}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#26a29d}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:transparent;color:inherit}.token.atrule,.token.attr-value,.token.keyword{color:#3f20ba}.token.class-name,.token.function{color:#f25cc1}.token.important,.token.regex,.token.variable{color:#f4d03f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-]>code[class*=language-],pre[data-line]{position:relative}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}</style><meta name="generator" content="Gatsby 3.9.1"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">六、CLR 类型加载器的设计 - Tuesday.</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Righteous"/><link data-react-helmet="true" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><meta data-react-helmet="true" name="description" content="dontpanic 的技术专栏"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta data-react-helmet="true" property="og:title" content="六、CLR 类型加载器的设计"/><meta data-react-helmet="true" property="og:site_name" content="Tuesday."/><meta data-react-helmet="true" property="og:description" content="dontpanic 的技术专栏"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="六、CLR 类型加载器的设计"/><meta data-react-helmet="true" name="twitter:description" content="dontpanic 的技术专栏"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=5476ae749c7ba8c0b0961dea57fd8358" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 48)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-c894c754cb747dde0ef3.js"/><link as="script" rel="preload" href="/framework-709552cd5aea54a8a9c3.js"/><link as="script" rel="preload" href="/9598fa14-489b91449ca8d4391871.js"/><link as="script" rel="preload" href="/9f92645c-5ef19c6477d93ab0a1ae.js"/><link as="script" rel="preload" href="/app-59bcc02cfe733b1951ad.js"/><link as="script" rel="preload" href="/component---gatsby-theme-apollo-docs-src-components-template-js-0aea2e61e3f3fa3d3a99.js"/><link as="fetch" rel="preload" href="/page-data/botr/6-type-loader/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1511030359.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2468095761.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2645605535.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 1ot73i">.css-1ot73i{position:-webkit-sticky;position:sticky;top:0;z-index:1;width:100%;color:#5A6270;background:#ffffff;border-width:0 0 1px 0;border-color:#DEE2E7;border-style:solid;height:48px;}</style><nav class="css-1ot73i e3whxbx6"><style data-emotion="css uv35fb">.css-uv35fb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;max-width:1440px;margin:0 auto;height:100%;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-uv35fb e3whxbx5"><style data-emotion="css la7jcn">.css-la7jcn{list-style-type:none;margin:0 12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><ul class="css-la7jcn e3whxbx4"><style data-emotion="css x2y83o">.css-x2y83o{font-size:1rem;margin:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-x2y83o a{color:inherit;padding:4px 12px;-webkit-text-decoration:none;text-decoration:none;border-radius:4px;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;}.css-x2y83o a:hover{opacity:0.8;color:#3f20ba;background:#EBEEF0;}</style><li class="css-x2y83o e3whxbx3"><a href="/"><style data-emotion="css 1k3i00y">.css-1k3i00y{font-family:'Righteous';color:#2F353F;-webkit-background-clip:text;background-clip:text;mix-blend-mode:multiply;}</style><span class="css-1k3i00y e3whxbx1">Tuesday.</span></a></li><li class="css-x2y83o e3whxbx3"><a href="/">首页</a></li><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/" target="_blank">博客</a></li><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/about" target="_blank">关于</a></li></ul><ul class="css-la7jcn e3whxbx4"><li class="css-x2y83o e3whxbx3"><a href="https://github.com/dontpanic92/tuesday" target="_blank"><style data-emotion="css vhc98e">.css-vhc98e{height:1.7rem;}</style><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15 fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg></a></li><li class="css-x2y83o e3whxbx3"><a href="/license"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="info-circle" class="svg-inline--fa fa-info-circle fa-w-16 fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"></path></svg></a></li></ul></div></nav><style data-emotion="css 1h2z9rg">.css-1h2z9rg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:calc(100vh - 48px);max-width:1440px;margin:0 auto;}</style><div class="css-1h2z9rg exdt29b0"><style data-emotion="css 1226uca">.css-1226uca{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:312px;height:calc(100vh - 48px);padding:24px;overflow-y:auto;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 850px){.css-1226uca{height:100%;background-color:white;box-shadow:0 0 48px rgba(0,0,0,0.25);position:fixed;z-index:2;opacity:0;visibility:hidden;-webkit-transform:translateX(-100%);-moz-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);transition-property:transform,opacity,visibility;transition-duration:150ms;transition-timing-function:ease-in-out;}}</style><aside class="css-1226uca ezgpdot2"><style data-emotion="css 1p14ewn">.css-1p14ewn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:24px;}</style><div class="css-1p14ewn ezgpdot1"><style data-emotion="css gbkvvb">.css-gbkvvb{color:#2F353F;-webkit-text-decoration:none;text-decoration:none;}</style><a href="/" class="css-gbkvvb ezgpdot0"><style data-emotion="css 135j8ps">.css-135j8ps{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:24px;}</style><div class="css-135j8ps eetev6l1"></div></a></div><div class="sidebar"><style data-emotion="css 18y74nd">.css-18y74nd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:32px;}</style><span class="css-18y74nd efh8xek1"><style data-emotion="css n6fyyw">.css-n6fyyw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:40px;}</style><div class="css-n6fyyw e19uvsm15"><style data-emotion="css s5xdrg">.css-s5xdrg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-s5xdrg e19uvsm10"><style data-emotion="css yx4e1e">.css-yx4e1e{width:1.5rem;height:1.5rem;margin:0;}</style><img src="/avatar.png" class="css-yx4e1e e19uvsm12"/><style data-emotion="css u85vmk">.css-u85vmk{margin:0 0 0 10px;font-size:1.125rem;}</style><span class="css-u85vmk e19uvsm11">dontpanic 的技术专栏</span></div></div></span><style data-emotion="css n8z9jl">.css-n8z9jl{margin-left:36px;margin-bottom:32px;list-style:none;}</style><ul class="css-n8z9jl ea7mcww6"></ul><div><style data-emotion="css 18f7tla">.css-18f7tla{position:relative;z-index:0;}.css-18f7tla .ea7mcww6{position:relative;z-index:2;}</style><div class="css-18f7tla ea7mcww4"><style data-emotion="css 1f4tdju">.css-1f4tdju{height:100%;width:100%;cursor:pointer;position:absolute;top:0;left:0;opacity:0;z-index:1;}.css-1f4tdju:hover~.ea7mcww3{opacity:0.8;}.css-1f4tdju:not(:checked)~ .ea7mcww3 svg{-webkit-transform:rotate(-90deg);-moz-transform:rotate(-90deg);-ms-transform:rotate(-90deg);transform:rotate(-90deg);}.css-1f4tdju:not(:checked)~ .ea7mcww6{display:none;}</style><input type="checkbox" value="公共语言运行时" class="css-1f4tdju ea7mcww1" checked=""/><style data-emotion="css a7yzoi">.css-a7yzoi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:12px 0;color:#2F353F;font-weight:bold;text-transform:uppercase;}.css-a7yzoi svg{margin-right:10px;height:10px;width:10px;}.css-a7yzoi.active{color:#3f20ba;}</style><div class="active css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>公共语言运行时</div><ul class="css-n8z9jl ea7mcww6"><style data-emotion="css r6fr8v">.css-r6fr8v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:0.95rem;line-height:1.5;margin-bottom:13px;}.css-r6fr8v a{color:inherit;-webkit-text-decoration:none;text-decoration:none;padding:3px 10px;margin:-3px -10px;border-radius:4px;}.css-r6fr8v a:hover{opacity:0.8;}.css-r6fr8v a.active{color:#3f20ba;pointer-events:none;font-weight:600;background:#F4F6F8;}</style><li class="css-r6fr8v ea7mcww5"><a href="/botr/1-introduction/">一、CLR 简介</a></li><li class="css-r6fr8v ea7mcww5"><a href="/botr/2-garbage-collection/">二、CLR 垃圾回收器的设计</a></li><li class="css-r6fr8v ea7mcww5"><a aria-current="page" class="active" href="/botr/6-type-loader/">六、CLR 类型加载器的设计</a></li></ul></div><div class="css-18f7tla ea7mcww4"><input type="checkbox" value="错误模型" class="css-1f4tdju ea7mcww1" checked=""/><div class="css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>错误模型</div><ul class="css-n8z9jl ea7mcww6"><li class="css-r6fr8v ea7mcww5"><a title="Introduction" href="/the-error-model/0-introduction/">〇、错误模型简介</a></li><li class="css-r6fr8v ea7mcww5"><a title="Ambitions and Learnings" href="/the-error-model/1-ambitions-and-learnings/">一、野心和经验</a></li><li class="css-r6fr8v ea7mcww5"><a title="Bugs Aren’t Recoverable Errors!" href="/the-error-model/2-bugs-arent-recoverable-errors/">二、Bug 不是可恢复错误！</a></li><li class="css-r6fr8v ea7mcww5"><a title="Reliability, Fault-Tolerance, and Isolation" href="/the-error-model/3-reliability-fault-tolerance-and-isolation/">三、可靠性、容错性和隔离性</a></li><li class="css-r6fr8v ea7mcww5"><a title="Bugs: Abandonment, Assertions, and Contracts" href="/the-error-model/4-bugs-abandonment-assertions-and-contracts/">四、Bugs：放弃、断言和合约</a></li><li class="css-r6fr8v ea7mcww5"><a title="Recoverable Errors: Type-Directed Exceptions" href="/the-error-model/5-ecoverable-errors-type-directed-exceptions/">五、可恢复错误：类型导向的异常</a></li><li class="css-r6fr8v ea7mcww5"><a title="Retrospective and Conclusions" href="/the-error-model/6-retrospective-and-conclusions/">六、回顾和总结</a></li></ul></div></div></div></aside><style data-emotion="css 1ff36h2">.css-1ff36h2{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><main class="css-1ff36h2 efh8xek6"><style data-emotion="css 1ip6okp">.css-1ip6okp{position:-webkit-sticky;position:sticky;top:0;left:0;z-index:1;}</style><header class="css-1ip6okp edldhn51"><style data-emotion="css xc8ji6">.css-xc8ji6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:0;padding:0 56px;background-color:white;}@media (max-width: 850px){.css-xc8ji6{padding:0 24px;}}</style><div class="css-xc8ji6 edldhn50"><style data-emotion="css 8jbk1d">.css-8jbk1d{display:none;}@media (max-width: 850px){.css-8jbk1d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-right:32px;color:#2F353F;}}</style><div class="css-8jbk1d efh8xek2"><style data-emotion="css 1m6zll5">.css-1m6zll5{padding:20px;margin-left:-20px;color:inherit;border:none;background:none;outline:none;cursor:pointer;}</style><button class="css-1m6zll5 e1qf1exz1"><style data-emotion="css 1ihqbbj">.css-1ihqbbj{height:24px;width:24px;display:block;fill:currentColor;}</style><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1ihqbbj e1qf1exz0 css-1a134qk"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M2.25 18.003h19.5M2.25 12.003h19.5M2.25 6.003h19.5"></path></g></svg></button></div></div></header><style data-emotion="css-global q9286l">html{scroll-padding-top:68px;}</style><style data-emotion="css ip9jqt">.css-ip9jqt{padding:40px 56px;padding-bottom:0;}@media (max-width: 850px){.css-ip9jqt{padding:32px 48px;}}@media (max-width: 600px){.css-ip9jqt{padding:24px 32px;}}</style><div class="css-ip9jqt ernxcdh2"><div class="header-wrapper"><style data-emotion="css cz947x">.css-cz947x:not(:last-child){margin-bottom:8px;}</style><h1 class="css-cz947x ei8t6h41">六、CLR 类型加载器的设计</h1></div><hr/><style data-emotion="css 1o129hd">.css-1o129hd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}</style><div class="css-1o129hd e694h6z7"><style data-emotion="css a181dj">.css-a181dj{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;width:0;}.css-a181dj .api-ref h4 code{font-size:1.1em;}.css-a181dj .api-ref *:not(pre)>code[class*="language-"]{padding:0;background:none;}</style><div class="css-a181dj e694h6z6"><style data-emotion="css sk9651">.css-sk9651 a[href]:not([class]){color:#2075d6;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 a[href]:not([class]):hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-sk9651 a[href]:not([class]) code{color:inherit;}.css-sk9651 h1 code,.css-sk9651 h2 code,.css-sk9651 h3 code,.css-sk9651 h4 code,.css-sk9651 h5 code,.css-sk9651 h6 code{white-space:normal;}.css-sk9651 h1 a,.css-sk9651 h2 a,.css-sk9651 h3 a,.css-sk9651 h4 a,.css-sk9651 h5 a,.css-sk9651 h6 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 h1 a:hover,.css-sk9651 h2 a:hover,.css-sk9651 h3 a:hover,.css-sk9651 h4 a:hover,.css-sk9651 h5 a:hover,.css-sk9651 h6 a:hover{color:#5A6270;}.css-sk9651 *:not(style)+ h2,.css-sk9651 *:not(style)+ h3,.css-sk9651 *:not(style)+ h4,.css-sk9651 *:not(style)+ h5{margin-top:64px;}.css-sk9651 img{display:block;max-width:100%;}.css-sk9651 .mermaid svg{max-width:100%;}</style><div class="content-wrapper css-sk9651 e694h6z5"><div><blockquote>
<p>这是一篇译文。作者：Ladi Prosek - 2007<br/>
原文链接：<a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/type-loader.md" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/coreclr/blob/master/Documentation/botr/type-loader.md</a></p>
</blockquote>
<h2 id="引言" style="position:relative"><a class="headingLink" href="#引言">引言</a></h2>
<p>在一个基于类的面向对象系统中，类型就是一种模板，它描述了每个独立的实例所包含的数据、以及它们能够提供的功能。如果没有定义一个对象的类型，我们就不可能创建出这个对象来<sup>1</sup>。如果我们说某两个对象的类型相同，那么它们一定是同一个类型的两个实例。事实上，这两个对象也定义了完全相同的成员，但这与类型判断完全无关。</p>
<p>上面这段话其实也很好的描述了一个典型的 C++ 系统。不过 CLR 还有一个非常重要的基本功能，那就是它能够提供完整的运行时类型信息。为了“管理”托管代码、并提供一个类型安全的环境，运行时必须在任何时刻都能够知晓任何对象的类型。获取类型信息时，也不能引入复杂的计算，因为“类型比较”这一操作会非常频繁地发生（比如，任何类型转换都会涉及查询当前对象的类型信息，以便确定转换是安全的、可以操作的）。</p>
<p>这种对性能上的需求，就把字典查询方法完全排除在外了。留给我们的，就只剩下下面这样的架构：</p>
<p>图 1 抽象、宏观的对象设计</p>
<p>在每个对象中，除了包含真正的实例数据，还有一个“type id”指针，指向一个代表了它的类型的结构。这样的概念与 C++ 中的虚表指针很像，然而不同的是，这种结构（我们先把它叫做“TYPE”，后面我们会更清楚地定义它）比虚表所包含的信息要多很多。比如，它还包含了类型的继承信息，以便我们能够回答“is-a”这样的问题。</p>
<p><sup>1</sup> C# 3.0 中的“匿名类型”能够让你无需显式定义类型即可创建一个对象，只需要直接列出它的所有字段即可。不要被这个功能蒙蔽双眼，编译器其实背着你创建了一个类型。</p>
<h3 id="相关阅读" style="position:relative"><a class="headingLink" href="#相关阅读">相关阅读</a></h3>
<p>[1] Martin Abadi, Luca Cardelli, A Theory of Objects, ISBN
978-0387947754</p>
<p>[2] Andrew Kennedy (<a href="https://github.com/andrewjkennedy" target="_blank" rel="noopener noreferrer">@andrewjkennedy</a>), Don Syme (<a href="https://github.com/dsyme" target="_blank" rel="noopener noreferrer">@dsyme</a>), <a href="http://research.microsoft.com/apps/pubs/default.aspx?id=64031" target="_blank" rel="noopener noreferrer">Design and Implementation of Generics
for the .NET Common Language
Runtime</a></p>
<p>[3] <a href="http://www.ecma-international.org/publications/standards/Ecma-335.htm" target="_blank" rel="noopener noreferrer">ECMA Standard for the Common Language Infrastructure (CLI)</a></p>
<h3 id="设计目标" style="position:relative"><a class="headingLink" href="#设计目标">设计目标</a></h3>
<p>有时我们也把类型加载器（type loader）叫做类加载器（class laoder），但严格来说这个叫法并不正确，因为类只能算是类型的一个子集，即引用类型。这个加载器也能加载值类型。类型加载器的终极目标是：当有人需要加载一个类型时，它能够构建出表示这个类型的数据结构。下面的这些性质是加载器所应该具备的：</p>
<ul>
<li>快速的类型查找（通过 Module 和 token 进行查找，或通过 Assembly 和类型名进行查找）。</li>
<li>对内存布局进行优化，以便占用较小的内存工作集、实现较高的缓存命中率、以及提高 JIT 编译后代码的效率。</li>
<li>类型安全——拒绝加载不正确的类型，并抛出 <code class="language-text">TypeLoadException</code>.</li>
<li>并发——能够扩展至多线程的场景。</li>
</ul>
<h2 id="类型加载器的架构" style="position:relative"><a class="headingLink" href="#类型加载器的架构">类型加载器的架构</a></h2>
<p>加载器的公开方法很少。尽管这几个方法的函数签名不尽相同，它们都有着相似的语义：接收一个元数据 <strong>token</strong> 或是类型名 <strong>name</strong> 字符串参数，它代表了某个类型或成员；接收另一个参数，代表了这个 token 所在的范围（某个 <strong>module</strong> 或是 <strong>assembly</strong>）；再接收一些额外信息，比如一些标志。它会以 <strong>handle</strong> 的型时返回加载好的实体。</p>
<p>在 JIT 时，通常会调用多次类型加载器。考虑这样的代码：</p>
<div class="gatsby-highlight" data-language="text"><style data-emotion="css 1gcd36t">.css-1gcd36t{margin-bottom:1.45rem;border:1px solid #DEE2E7;border-radius:4px;}</style><div class="css-1gcd36t e1ulzjg73"><style data-emotion="css r8v8pb">.css-r8v8pb{padding:15px;background-color:#F4F6F8;overflow:auto;}</style><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">object CreateClass()
{
    return new MyClass();
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>在 IL 层面，<code class="language-text">MyClass</code> 以元数据 token 的方式被引用。<code class="language-text">JIT_New</code> 帮助方法是真正做实例化工作的函数，为了生成对 <code class="language-text">JIT_New</code> 调用指令， JIT 会要求类型加载器加载这个类型，并返回一个 handle。这个 handle 会被直接以立即数的形式嵌入到 JIT 编译后的代码中。由于类型和成员是在 JIT 阶段被解析和加载的（而不是在运行时），因此下面这样的代码很具有迷惑性：</p>
<p>(译注：CLR 会先对函数进行 JIT 编译，而后才会执行它)</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">object CreateClass()
{
    try {
        return new MyClass();
    } catch (TypeLoadException) {
        return null;
    }
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>如果 <code class="language-text">MyClass</code> 类型加载失败（比如它所在的 Assembly 刚好在文件系统中被删掉了），它们这段代码仍然会抛出 <code class="language-text">TypeLoadException</code>。<code class="language-text">catch</code> 块没有捕获到这个异常的原因是是：这段代码根本没有执行！异常是在 JIT 时被抛出的，只能被调用 <code class="language-text">CreateClass</code> 的函数（进而触发了 JIT 编译）所捕捉。不仅如此，考虑到存在内联（inline）这一特性，触发 JIT 编译的时机有时并不是那么明显，因此用户不应该依赖于这种难以琢磨的行为。</p>
<h3 id="关键数据结构" style="position:relative"><a class="headingLink" href="#关键数据结构">关键数据结构</a></h3>
<p>在 CLR 中，最通用的类型表示方法是 <code class="language-text">TypeHandle</code>。它是对 <code class="language-text">MethodTable</code> 以及 <code class="language-text">TypeDesc</code> 的抽象，即它要么封装了一个指向 <code class="language-text">MethodTable</code> 的指针（它代表了“普通”的类型，比如 <code class="language-text">System.Object</code> 或是 <code class="language-text">List&lt;string&gt;</code>），要么封装了一个指向了 <code class="language-text">TypeDesc</code> 的指针（代表了 byref、指针、函数指针、数组以及泛型类型）。它就是类型的标志，当且仅当两个 handle 相同时，它们所表示的类型也相同。为了节省空间， <code class="language-text">TypeHandle</code> 通过指针的第二低位（the second lowest bit）来标记它到底是一个 <code class="language-text">TypeDesc</code> 还是 <code class="language-text">MethodTable</code> 。如果第二低位是 1 (即 (ptr | 2))，则代表它是一个 <code class="language-text">TypeDesc</code><sup>2</sup>。<code class="language-text">TypeDesc</code> 则是对下面几种类型的抽象：</p>
<p>图 2 TypeDesc 体系</p>
<p><code class="language-text">TypeDesc</code></p>
<p>抽象的类型描述符。具体的描述符类型由标志位决定。</p>
<p><code class="language-text">TypeVarTypeDesc</code></p>
<p>代表了一个类型变量，例如在 <code class="language-text">List&lt;T&gt;</code> 或是 <code class="language-text">Array.Sort&lt;T&gt;</code> 中的那个 <code class="language-text">T</code>（详见下文关于泛型的部分）。类型变量不会由多个类型或方法共享，因此每个变量都只有一个 owner。</p>
<p><code class="language-text">FnPtrTypeDesc</code></p>
<p>代表了一个函数指针，它是由一组变长的类型 handle 列表组成的，这组 handle 表示了返回值和参数的类型。这个描述符并不常见，因为 C# 不支持函数指针。不过，托管 C++ 会使用这个描述符。</p>
<p><code class="language-text">ParamTypeDesc</code></p>
<p>这个描述符代表了 byref 和指针类型。 在 C# 的方法参数中的使用 <code class="language-text">ref</code> 和 <code class="language-text">out</code> 关键字即可得到这种类型<sup>3</sup>；指针类型则代表了非托管的指向数据的指针，用于 unsafe C# 和托管 C++。</p>
<p><code class="language-text">ArrayTypeDesc</code></p>
<p>代表了数组类型。它继承自 <code class="language-text">ParamTypeDesc</code>，因为它同样只有一个类型参数（即元素的类型）。这与泛型实例化不同，泛型实例化所需要的参数是不定的。</p>
<p><code class="language-text">MethodTable</code></p>
<p>目前，运行时中最核心的类型数据结构就是它了。它代表着所有没有落入到上述类别中的类型（包括基本类型、开放（open）或闭合（closed）泛型类型）。它包含了所有需要快速查找的信息，例如它的父类型、实现的接口，以及虚表。</p>
<p><code class="language-text">EEClass</code></p>
<p><code class="language-text">MethodTable</code> 数据分为两类，“热（hot）” 结构和 “冷（cold）” 结构，这将有利于降低内存占用以及更有利于缓存的使用。<code class="language-text">MethodTable</code> 本身只用来存储常用（热）数据，即那些为了执行程序所必须的数据。<code class="language-text">EEClass</code> 保存不常用的（冷）数据，这些数据通常只在类型加载、JIT 编译或是反射时才需要。每一个 <code class="language-text">MethodTable</code> 都指向一个 <code class="language-text">EEClass</code>。</p>
<p>此外，<code class="language-text">EEClass</code> 在泛型类型之间是共享的。多个泛型 <code class="language-text">MethodTable</code> 可能会指向同一个 <code class="language-text">EEClass</code>。这就对能够存放在 <code class="language-text">EEClass</code> 中的数据提出了额外的限制条件。</p>
<p><code class="language-text">MethodDesc</code></p>
<p>顾名思义，这个结构描述了一个方法。其实这个结构通常都以它的一些子类型出现，不过大多数子类型都已经超出了这篇文章的范围。其中有一个子类型值得一提：<code class="language-text">InstantiatedMethodDesc</code>，它在泛型类型中扮演了一个重要的角色。更多信息请参考
<a href="/botr/method-descriptor.md/"><strong>Method Descriptor Design</strong></a>。</p>
<p><code class="language-text">FieldDesc</code></p>
<p>与 <code class="language-text">MethodDesc</code> 类似，这个结构描述的是一个字段。除了某些特定的 COM 交互场景，执行引擎根本不在乎属性（property）和事件（events），因为它们最终还是会指向各种方法和字段。只有编译器、以及反射机制能够生成或理解属性和事件，这只是一种语法糖。</p>
<p><sup>2</sup>这在调试时非常有用。如果 <code class="language-text">TypeHandle</code> 的值以2、6、A、或 E 结尾，那么它就不是一个 <code class="language-text">MethodTable</code>。如果想要访问到 <code class="language-text">TypeDesc</code>，这个多余的位需要清零。</p>
<p><sup>3</sup>需要注意的是，<code class="language-text">ref</code> 和 <code class="language-text">out</code> 之间只在参数属性上有所不同。对于类型系统来说，它们其实是相同的类型。</p>
<h3 id="加载级别（load-levels）" style="position:relative"><a class="headingLink" href="#加载级别（load-levels）">加载级别（Load Levels）</a></h3>
<p>我们可以使用诸如 typedef/typeref/typespec 之类的 <strong>token</strong>、并指定一个 <strong>Module</strong> 来加载类型。当类型加载器加载类型时，它并不会一次性做完所有的工作，而是分阶段完成的。这样做的原因是，有一些类型可能会依赖其他类型，因此如果要完成类型的加载，则必须先加载那些被依赖的类型，二者可能会导致无限递归和死锁。例如：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">class A&lt;T&gt; : C&lt;B&lt;T&gt;&gt;
{ }

class B&lt;T&gt; : C&lt;A&lt;T&gt;&gt;
{ }

class C&lt;T&gt;
{ }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>它们都是合法的类型，很明显 <code class="language-text">A</code> 依赖于 <code class="language-text">B</code>，同时 <code class="language-text">B</code> 也依赖于 <code class="language-text">A</code>。</p>
<p>加载类型时，加载器会先创建一些结构用来表示被加载的类型，此时并不需要加载其他被依赖的类型。这一步完成后，这些结构就可以被其它地方所引用，例如把指向它的指针塞进其他结构中。然后假踩起就会不断地一点一点把这些结构填满，一直到真正加载完这些类型。在上面的例子中，<code class="language-text">A</code> 和 <code class="language-text">B</code> 的基类会首先近似为一种不需要依赖其他类型的类型，然后才会被真正的类型所替代。</p>
<p>所谓的加载级别，就是为了定义这种未完全加载的状态。从 <code class="language-text">CLASS_LOAD_BEGIN</code> 开始，到 <code class="language-text">CLASS_LOADED</code> 结束，中间穿插了很多中间级别。在 <a href="https://github.com/dotnet/coreclr/blob/master/src/vm/classloadlevel.h" target="_blank" rel="noopener noreferrer">classloadlevel.h</a> 中，有很详细的注释对各个加载级别进行了说明。例如，类型可以以 NGEN 镜像的形式存储，但并不是简单地把它们映射到内存就能使用，而是需要“恢复”（restore）。加载等级中有一级叫做 <code class="language-text">CLASS_LOAD_UNRESTORED</code>，它就描述了这种需要“恢复”的状态。</p>
<p>更多对于加载等级的详细解释，请参考 <a href="http://research.microsoft.com/apps/pubs/default.aspx?id=64031" target="_blank" rel="noopener noreferrer">Design and Implementation of Generics
for the .NET Common Language
Runtime</a>。</p>
<h3 id="generics" style="position:relative"><a class="headingLink" href="#generics">Generics</a></h3>
<p>在没有泛型的世界里，一切都很友好、所有人都很开心——因为每个普通的类型（即不是由 <code class="language-text">TypeDesc</code> 所表示的类型）都只有一个 <code class="language-text">MethodTable</code>，其中包含了指向了它所关联的 <code class="language-text">EEClass</code> 的指针，而 <code class="language-text">EEClass</code> 又指回了这个 <code class="language-text">MethodTable</code>。为了节省空间，代表了方法的 <code class="language-text">MethodDesc</code> 几个组成一组，每组之间以链表的形式相连<sup>4</sup>：</p>
<p>图 3 没有泛型方法的非泛型类型</p>
<p><sup>4</sup>在执行托管代码时，并不是需要去查询这些组才能进行方法调用。方法调用是一种非常常见的操作，通常只需要 <code class="language-text">MethodTable</code> 中的信息就能完成。</p>
<h4 id="术语" style="position:relative"><a class="headingLink" href="#术语">术语</a></h4>
<p><strong>泛型形式参数（Generic Parameter）</strong></p>
<p>是指一个占位符，能够被其他类型替代，例如声明 <code class="language-text">List&lt;T&gt;</code> 中的 <code class="language-text">T</code>。有时也称作形式类型参数（formal type parameter）。泛型形参具有名字，以及可选的泛型约束。</p>
<p><strong>泛型实际参数(Generic Argument)</strong></p>
<p>是指用来替代形参的那个类型，例如 <code class="language-text">List&lt;int&gt;</code> 中的 <code class="language-text">int</code>。需要注意的是，泛型形参也可以被用作一个实参。例如：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">List&lt;T&gt; GetList&lt;T&gt;()
{
    return new List&lt;T&gt;();
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这个方法有一个泛型形参 <code class="language-text">T</code>，它被用作了泛型列表的泛型实参。</p>
<p><strong>泛型约束</strong></p>
<p>是可选的，它是指当泛型实参替代反省形参时所需满足的要求。不满足要求的类型不能替换反省实参，这是由类型加载器所强制要求的。泛型约束分为三类：</p>
<ol>
<li>特殊约束</li>
</ol>
<ul>
<li>
<p>引用类型约束——泛型实参必须是引用类型（与之相对的是值类型）。C# 使用 <code class="language-text">class</code> 关键字来表示这种约束。</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;T&gt; where T : class</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
</li>
<li>
<p>值类型约束——反省实参必须是除了 <code class="language-text">System.Nulable&lt;T&gt;</code> 之外的值类型。 C# 使用 <code class="language-text">struct</code> 关键字来表示。</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;T&gt; where T : struct</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
</li>
<li>
<p>默认构造函数约束——泛型实参必须要具有一个公开的无参构造函数。C# 使用 <code class="language-text">new()</code> 来表示这种约束。</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;T&gt; where T : new()</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
</li>
</ul>
<ol start="2">
<li>
<p>基类型约束——泛型实参必须继承自（或者就是）给定的非接口类型。很显然，这种约束要么没有，要么只能有一个引用类型作为约束。</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;T&gt; where T : EventArgs</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
</li>
<li>
<p>接口实现约束——泛型实参必须实现（或者就是）给定的接口类型。多个接口可以同时作为约束：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;T&gt; where T : ICloneable, IComparable&lt;T&gt;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
</li>
</ol>
<p>上面这些约束之间的关系是“与”（AND），即一个泛型形参可以被约束为需要继承自一个给定的类型、实现几个接口、同时还需要有默认构造函数。类型声明中所有的泛型形参都可以用来表达约束，这可能会引入参数之间的互相依赖：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;S, T, U&gt; 
	where S : T 
	where T : IList&lt;U&gt; {
    void f&lt;V&gt;(V v) where V : S {}
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p><strong>实例（Instantiation）</strong></p>
<p>是用来替换泛型类型或泛型方法中泛型形参的一组泛型实参。每个加载了的泛型类型和方法都有它自己的实例。</p>
<p><strong>典型实例（Typical Instantiation）</strong></p>
<p>是指按照泛型形参声明的顺序，仅包含泛型类型或方法自己的类型形参的一个实例。对于每一个泛型类型和方法，仅存在一个典型实例。通常来说，当我们提到开放泛型类型（Open generic type）时，就是指它的典型实例。例如：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">public class A&lt;S, T, U&gt; {}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
<p>C# 会把 <code class="language-text">typeof(A&lt;,,&gt;)</code> 编译为一个 IdToken A&#x27;3，运行时就会加载使用 <code class="language-text">S</code>、<code class="language-text">T</code>、<code class="language-text">U</code> 实例化的 <code class="language-text">A`3</code>。</p>
<p><strong>规范实例（Canonical Instantiation）</strong></p>
<p>是指所有的泛型实参均为 <code class="language-text">System.__Canon</code> 的实例。<code class="language-text">System.__Canon</code> 是定义在 mscorlib 中的一个内部类型，它就只充当一种约定，与其他的泛型实参都不同。类型和方法的规范实例用来代表所有的其他实例，并且携带有会在所有实例之间共享的信息。显然，<code class="language-text">System.__Canon</code> 无法满足泛型形参上可能携带的任何约束，因此对于 <code class="language-text">System.__Canon</code> 约束检查是个特例，加载器会将不满足的约束忽略。</p>
<h3 id="共享" style="position:relative"><a class="headingLink" href="#共享">共享</a></h3>
<p>随着泛型的加入，运行时需要加载的类型变得更多了。虽然泛型类型的不同实例（例如 <code class="language-text">List&lt;string&gt;</code> 和 <code class="language-text">List&lt;object&gt;</code>）是不同的类型，也各自有它们自己的 <code class="language-text">MethodTable</code>，但还是有有一些信息是重复的，可以共享。这种共享会给内存占用和性能都带来积极影响。</p>
<p>图 4 不包含泛型方法的泛型类型——共享 EEClass</p>
<p>目前所有包含引用类型的实例都会共享同一个 <code class="language-text">EEClass</code> 以及 <code class="language-text">MethodDesc</code>。这种方式可行的原因在于，所有的引用所占用的内存大小都一样，例如4个字节或是8个字节，因此这些类型的布局都相同。上图示意了 <code class="language-text">List&lt;object&gt;</code> 和 <code class="language-text">List&lt;string&gt;</code> 的情形。那个规范的 <code class="language-text">MethodTable</code> 会在第一个引用类型实例加载时自动创建，它里面包含了那些常用的、不局限于某个特定实例的数据，例如非虚的方法槽以及 <code class="language-text">RemotableMethodInfo</code>。只包含值类型的实例不会共享信息，每一个实例化的类型都会有它自己独立的 <code class="language-text">EEClass</code>。</p>
<p>已加载的泛型类型的 <code class="language-text">MethodTable</code> 会被缓存在一个哈希表中，这个哈希表由加载它们的模块所持有。在一个新的实例构造之前，加载器会首先查询这个哈希表，这样就不会出现有同一个类型具有多个 <code class="language-text">MethodTable</code> 实例的情况了。</p>
<p>更多关于泛型共享的细节，请参考 <a href="http://research.microsoft.com/apps/pubs/default.aspx?id=64031" target="_blank" rel="noopener noreferrer">Design and Implementation of Generics for the .NET Common Language Runtime</a>。</p></div></div><style data-emotion="css 1f6gfyy">.css-1f6gfyy{display:none;margin-top:48px;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}@media (max-width: 1120px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (max-width: 850px){.css-1f6gfyy{display:none;}}@media (max-width: 600px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-top:24px;}}</style><div class="css-1f6gfyy e694h6z0"></div><style data-emotion="css 9ckfit">.css-9ckfit{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:64px 0;}@media (max-width: 850px){.css-9ckfit{padding:32px 0;}}</style><nav class="css-9ckfit e1sfxy7w4"><style data-emotion="css spe9v1">.css-spe9v1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-spe9v1 svg{height:16px;width:16px;}.css-spe9v1:hover{opacity:0.8;}</style><a class="css-spe9v1 e1sfxy7w3" href="/botr/2-garbage-collection/"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 14 24" class="css-1a134qk"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.5.75L1.78 11.47a.749.749 0 0 0-.001 1.059l.001.001L12.5 23.25"></path></svg><style data-emotion="css 16mhdhi">.css-16mhdhi{margin-left:24px;text-align:left;}@media (max-width: 850px){.css-16mhdhi{margin-left:16px;}}</style><div class="css-16mhdhi e1sfxy7w2"><style data-emotion="css 1vhhq4p">.css-1vhhq4p{letter-spacing:0.142em;text-transform:uppercase;font-size:12px;}</style><div class="css-1vhhq4p e1sfxy7w1">Previous</div><style data-emotion="css mtbysh">.css-mtbysh{color:#2F353F;}</style><div class="css-mtbysh e1sfxy7w0">二、CLR 垃圾回收器的设计</div></div></a><a style="margin-left:auto" class="css-spe9v1 e1sfxy7w3" href="/the-error-model/0-introduction/"><style data-emotion="css 18eg9eb">.css-18eg9eb{margin-right:24px;text-align:right;}@media (max-width: 850px){.css-18eg9eb{margin-right:16px;}}</style><div class="css-18eg9eb e1sfxy7w2"><div class="css-1vhhq4p e1sfxy7w1">Next</div><div class="css-mtbysh e1sfxy7w0">〇、错误模型简介</div></div><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.5.75l10.72 10.72a.749.749 0 0 1 .001 1.059l-.001.001L5.5 23.25"></path></svg></a></nav><div id="comments-container"></div></div><style data-emotion="css 10vu48r">.css-10vu48r{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:240px;max-height:calc(100vh - 0px - 48px);margin-top:-36px;padding:40px 0;margin-left:40px;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 1120px){.css-10vu48r{display:none;}}@media (max-width: 850px){.css-10vu48r{display:block;}}@media (max-width: 600px){.css-10vu48r{display:none;}}</style><aside class="css-10vu48r e694h6z4"><style data-emotion="css 16ceglb">.css-16ceglb{font-weight:600;}</style><h4 class="css-16ceglb e694h6z3">六、CLR 类型加载器的设计</h4><style data-emotion="css gmdgof">.css-gmdgof{margin-left:0;margin-bottom:48px;overflow:auto;}</style><ul class="css-gmdgof e1wyoreh1"><style data-emotion="css 1h656g5">.css-1h656g5{list-style:none;font-size:1rem;line-height:inherit;}.css-1h656g5.active{color:#3f20ba;font-weight:bold;}.css-1h656g5 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-1h656g5 a:hover{opacity:0.8;}</style><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#引言">引言</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#相关阅读">相关阅读</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#设计目标">设计目标</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#类型加载器的架构">类型加载器的架构</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#关键数据结构">关键数据结构</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#加载级别（load-levels）">加载级别（Load Levels）</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#generics">Generics</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#术语">术语</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#共享">共享</a></li></ul></aside></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TZ8V0QY4Z8"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-TZ8V0QY4Z8', {"send_page_view":false});
      }
      </script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/botr/6-type-loader/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-6e0f68151e061361b855.js"],"app":["/app-59bcc02cfe733b1951ad.js"],"component---gatsby-theme-apollo-core-src-pages-404-js":["/component---gatsby-theme-apollo-core-src-pages-404-js-fe929beb924e2cdddf9c.js"],"component---gatsby-theme-apollo-docs-src-components-template-js":["/component---gatsby-theme-apollo-docs-src-components-template-js-0aea2e61e3f3fa3d3a99.js"],"component---src-pages-index-mdx":["/component---src-pages-index-mdx-5ab88f128cd21fbf35a6.js"],"component---src-pages-license-mdx":["/component---src-pages-license-mdx-b7ef07ead0f0018ea135.js"]};/*]]>*/</script><script src="/polyfill-6e0f68151e061361b855.js" nomodule=""></script><script src="/component---gatsby-theme-apollo-docs-src-components-template-js-0aea2e61e3f3fa3d3a99.js" async=""></script><script src="/app-59bcc02cfe733b1951ad.js" async=""></script><script src="/9f92645c-5ef19c6477d93ab0a1ae.js" async=""></script><script src="/9598fa14-489b91449ca8d4391871.js" async=""></script><script src="/framework-709552cd5aea54a8a9c3.js" async=""></script><script src="/webpack-runtime-c894c754cb747dde0ef3.js" async=""></script></body></html>