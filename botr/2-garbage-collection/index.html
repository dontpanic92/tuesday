<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.14c0dd40a340ad0cd240.css" data-identity="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}@font-face{font-family:Source Code Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPevT.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7g.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlxdr.ttf) format("truetype")}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{font-family:Source Sans Pro,sans-serif}code,pre{font-family:Source Code Pro,monospace}html{font-size:100%;line-height:1.45;overflow-y:auto}body{color:#2f353f}div.mermaid,h1,h2,h3,h4,h5,h6,img,ol,p,ul{margin:0 0 24px}h4,h5{margin-bottom:1.0875rem}h1,h2,h3,h4,h5,h6{color:#2f353f;line-height:1.1}h1,h2,h3,h4,h6{font-weight:400}h1{font-size:2.5rem}h2{font-size:1.73286rem}h3{font-size:1.4427rem}h4{font-size:1.125rem;font-weight:700}h5,li,p{font-size:1rem}h6{font-size:.875rem}li,p{line-height:1.7}li li{font-size:1.05rem;line-height:1.4}ol,ul{margin-left:24px;padding:0}li{margin-bottom:12px}li>ol,li>ul{margin-top:12px}blockquote{border-left:2px solid #3f20ba;margin-left:0;padding:12px 20px}blockquote>ol,blockquote>p,blockquote>ul{font-size:inherit}blockquote>ol:last-child,blockquote>p:last-child,blockquote>ul:last-child{margin-bottom:0}blockquote li,td li{font-size:inherit;line-height:1.1}form{margin-bottom:0}hr{background-color:#dee2e7;border:none;height:1px;margin-bottom:23px}img.screenshot{border-radius:8px;box-shadow:0 0 0 1px rgba(18,21,26,.04),0 1px 4px 0 rgba(0,0,0,.08)}.gatsby-code-title{align-items:center;color:#5a6270;display:flex;font-family:Source Code Pro,monospace;font-size:15px;height:37px;margin-bottom:-37px;padding-left:19px}.gatsby-highlight-code-line{background-color:#ebeef0;display:block;margin-left:-3.5em;margin-right:-1em;padding-left:3.5em;padding-right:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.5em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows>span:before{color:#cad0d8}code[class*=language-],pre[class*=language-]{color:#2f353f;direction:ltr;font-family:Source Code Pro,monospace;font-size:15px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#f4f6f8;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{background:#ebeef0;border-radius:.3em;color:#f25cc1;font-size:.9em;padding:.1em .15em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#959daa}.token.punctuation{color:#5a6270}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#f25cc1}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#26a29d}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:transparent;color:inherit}.token.atrule,.token.attr-value,.token.keyword{color:#3f20ba}.token.class-name,.token.function{color:#f25cc1}.token.important,.token.regex,.token.variable{color:#f4d03f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-]>code[class*=language-],pre[data-line]{position:relative}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}</style><meta name="generator" content="Gatsby 3.14.6"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">二、CLR 垃圾回收器的设计 - Tuesday.</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Righteous"/><link data-react-helmet="true" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><meta data-react-helmet="true" name="description" content="dontpanic 的技术专栏"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta data-react-helmet="true" property="og:title" content="二、CLR 垃圾回收器的设计"/><meta data-react-helmet="true" property="og:site_name" content="Tuesday."/><meta data-react-helmet="true" property="og:description" content="dontpanic 的技术专栏"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="二、CLR 垃圾回收器的设计"/><meta data-react-helmet="true" name="twitter:description" content="dontpanic 的技术专栏"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=5476ae749c7ba8c0b0961dea57fd8358" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 48)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><link as="script" rel="preload" href="/webpack-runtime-f03f468fb1185576d27a.js"/><link as="script" rel="preload" href="/framework-bcf4c1d2232a4f1b31b7.js"/><link as="script" rel="preload" href="/9598fa14-6a39ed586f092d891d9f.js"/><link as="script" rel="preload" href="/9f92645c-df813722f906b02fa9fd.js"/><link as="script" rel="preload" href="/app-d3467ceeff988abf002f.js"/><link as="script" rel="preload" href="/component---gatsby-theme-apollo-docs-src-components-template-js-c0bfeb7a9d55823478d5.js"/><link as="fetch" rel="preload" href="/page-data/botr/2-garbage-collection/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1511030359.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2468095761.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2645605535.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 1ot73i">.css-1ot73i{position:-webkit-sticky;position:sticky;top:0;z-index:1;width:100%;color:#5A6270;background:#ffffff;border-width:0 0 1px 0;border-color:#DEE2E7;border-style:solid;height:48px;}</style><nav class="css-1ot73i e3whxbx6"><style data-emotion="css uv35fb">.css-uv35fb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;max-width:1440px;margin:0 auto;height:100%;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-uv35fb e3whxbx5"><style data-emotion="css la7jcn">.css-la7jcn{list-style-type:none;margin:0 12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><ul class="css-la7jcn e3whxbx4"><style data-emotion="css x2y83o">.css-x2y83o{font-size:1rem;margin:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-x2y83o a{color:inherit;padding:4px 12px;-webkit-text-decoration:none;text-decoration:none;border-radius:4px;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;}.css-x2y83o a:hover{opacity:0.8;color:#3f20ba;background:#EBEEF0;}</style><li class="css-x2y83o e3whxbx3"><a href="/"><style data-emotion="css 1k3i00y">.css-1k3i00y{font-family:'Righteous';color:#2F353F;-webkit-background-clip:text;background-clip:text;mix-blend-mode:multiply;}</style><span class="css-1k3i00y e3whxbx1">Tuesday.</span></a></li><li class="css-x2y83o e3whxbx3"><a href="/">首页</a></li></ul><ul class="css-la7jcn e3whxbx4"><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/" target="_blank" title="随笔博客"><style data-emotion="css vhc98e">.css-vhc98e{height:1.7rem;}</style><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="blog" class="svg-inline--fa fa-blog fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M172.2 226.8c-14.6-2.9-28.2 8.9-28.2 23.8V301c0 10.2 7.1 18.4 16.7 22 18.2 6.8 31.3 24.4 31.3 45 0 26.5-21.5 48-48 48s-48-21.5-48-48V120c0-13.3-10.7-24-24-24H24c-13.3 0-24 10.7-24 24v248c0 89.5 82.1 160.2 175 140.7 54.4-11.4 98.3-55.4 109.7-109.7 17.4-82.9-37-157.2-112.5-172.2zM209 0c-9.2-.5-17 6.8-17 16v31.6c0 8.5 6.6 15.5 15 15.9 129.4 7 233.4 112 240.9 241.5.5 8.4 7.5 15 15.9 15h32.1c9.2 0 16.5-7.8 16-17C503.4 139.8 372.2 8.6 209 0zm.3 96c-9.3-.7-17.3 6.7-17.3 16.1v32.1c0 8.4 6.5 15.3 14.8 15.9 76.8 6.3 138 68.2 144.9 145.2.8 8.3 7.6 14.7 15.9 14.7h32.2c9.3 0 16.8-8 16.1-17.3-8.4-110.1-96.5-198.2-206.6-206.7z"></path></svg></a></li><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/about" target="_blank" title="关于我"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="info-circle" class="svg-inline--fa fa-info-circle fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"></path></svg></a></li><li class="css-x2y83o e3whxbx3"><a href="https://github.com/dontpanic92/tuesday" target="_blank" title="本站源代码"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg></a></li><li class="css-x2y83o e3whxbx3"><a href="/license" title="协议：CC BY-NC-SA 4.0"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="creative-commons" class="svg-inline--fa fa-creative-commons fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93-22.13 0-33.22 14.61-33.22 43.84 0 23.57 9.21 43.84 33.22 43.84 14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98-22.6 0-73.96-10.32-73.96-77.05 0-58.69 43-77.06 72.63-77.06 30.72-.01 52.7 11.95 65.99 35.86zm143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93-22.14 0-33.22 14.61-33.22 43.84 0 23.55 9.23 43.84 33.22 43.84 14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98-22.69 0-73.96-9.87-73.96-77.05 0-58.67 42.97-77.06 72.63-77.06 30.71-.01 52.58 11.95 65.56 35.86zM247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248 129.93 0 248.44-100.87 248.44-248 0-137.87-106.62-248-248.44-248zm.87 450.81c-112.54 0-203.7-93.04-203.7-202.81 0-105.42 85.43-203.27 203.72-203.27 112.53 0 202.82 89.46 202.82 203.26-.01 121.69-99.68 202.82-202.84 202.82z"></path></svg></a></li></ul></div></nav><style data-emotion="css 1h2z9rg">.css-1h2z9rg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:calc(100vh - 48px);max-width:1440px;margin:0 auto;}</style><div class="css-1h2z9rg exdt29b0"><style data-emotion="css 1226uca">.css-1226uca{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:312px;height:calc(100vh - 48px);padding:24px;overflow-y:auto;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 850px){.css-1226uca{height:100%;background-color:white;box-shadow:0 0 48px rgba(0,0,0,0.25);position:fixed;z-index:2;opacity:0;visibility:hidden;-webkit-transform:translateX(-100%);-moz-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);transition-property:transform,opacity,visibility;transition-duration:150ms;transition-timing-function:ease-in-out;}}</style><aside class="css-1226uca ezgpdot2"><style data-emotion="css 1p14ewn">.css-1p14ewn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:24px;}</style><div class="css-1p14ewn ezgpdot1"><style data-emotion="css gbkvvb">.css-gbkvvb{color:#2F353F;-webkit-text-decoration:none;text-decoration:none;}</style><a href="/" class="css-gbkvvb ezgpdot0"><style data-emotion="css 135j8ps">.css-135j8ps{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:24px;}</style><div class="css-135j8ps eetev6l1"></div></a></div><div class="sidebar"><style data-emotion="css 18y74nd">.css-18y74nd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:32px;}</style><span class="css-18y74nd efh8xek1"><style data-emotion="css n6fyyw">.css-n6fyyw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:40px;}</style><div class="css-n6fyyw e19uvsm15"><style data-emotion="css s5xdrg">.css-s5xdrg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-s5xdrg e19uvsm10"><style data-emotion="css yx4e1e">.css-yx4e1e{width:1.5rem;height:1.5rem;margin:0;}</style><img src="/avatar.png" class="css-yx4e1e e19uvsm12"/><style data-emotion="css u85vmk">.css-u85vmk{margin:0 0 0 10px;font-size:1.125rem;}</style><span class="css-u85vmk e19uvsm11">dontpanic 的技术专栏</span></div></div></span><style data-emotion="css n8z9jl">.css-n8z9jl{margin-left:36px;margin-bottom:32px;list-style:none;}</style><ul class="css-n8z9jl ea7mcww6"></ul><div><style data-emotion="css 18f7tla">.css-18f7tla{position:relative;z-index:0;}.css-18f7tla .ea7mcww6{position:relative;z-index:2;}</style><div class="css-18f7tla ea7mcww4"><style data-emotion="css 1f4tdju">.css-1f4tdju{height:100%;width:100%;cursor:pointer;position:absolute;top:0;left:0;opacity:0;z-index:1;}.css-1f4tdju:hover~.ea7mcww3{opacity:0.8;}.css-1f4tdju:not(:checked)~ .ea7mcww3 svg{-webkit-transform:rotate(-90deg);-moz-transform:rotate(-90deg);-ms-transform:rotate(-90deg);transform:rotate(-90deg);}.css-1f4tdju:not(:checked)~ .ea7mcww6{display:none;}</style><input type="checkbox" value="栈缓冲区溢出 101" class="css-1f4tdju ea7mcww1" checked=""/><style data-emotion="css a7yzoi">.css-a7yzoi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:12px 0;color:#2F353F;font-weight:bold;text-transform:uppercase;}.css-a7yzoi svg{margin-right:10px;height:10px;width:10px;}.css-a7yzoi.active{color:#3f20ba;}</style><div class="css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>栈缓冲区溢出 101</div><ul class="css-n8z9jl ea7mcww6"><style data-emotion="css r6fr8v">.css-r6fr8v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:0.95rem;line-height:1.5;margin-bottom:13px;}.css-r6fr8v a{color:inherit;-webkit-text-decoration:none;text-decoration:none;padding:3px 10px;margin:-3px -10px;border-radius:4px;}.css-r6fr8v a:hover{opacity:0.8;}.css-r6fr8v a.active{color:#3f20ba;pointer-events:none;font-weight:600;background:#F4F6F8;}</style><li class="css-r6fr8v ea7mcww5"><a href="https://ctf.dontpanic.blog/notes/stack-buffer-overflow-101.html" target="_blank" rel="noopener noreferrer">一、栈缓冲区溢出 101<style data-emotion="css 1dl06o9">.css-1dl06o9{height:14px;width:14px;vertical-align:-1px;margin-left:8px;color:#959DAA;}</style><style data-emotion-css="qic6h7">.css-qic6h7{overflow:visible;height:25px;}.css-qic6h7 *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 25 25" style="height:1rem" class="css-1dl06o9 ea7mcww0 css-qic6h7"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.141 4.894H3.576A1.977 1.977 0 0 0 1.6 6.871v14.494c0 1.09.885 1.976 1.976 1.976h14.495a1.977 1.977 0 0 0 1.976-1.976V12.8M17.412 1.6h4.94a.99.99 0 0 1 .99.988V7.53m-10.883 4.952L23.05 1.89"></path></svg></a></li><li class="css-r6fr8v ea7mcww5"><a href="https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html" target="_blank" rel="noopener noreferrer">二、ASLR<style data-emotion-css="qic6h7">.css-qic6h7{overflow:visible;height:25px;}.css-qic6h7 *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 25 25" style="height:1rem" class="css-1dl06o9 ea7mcww0 css-qic6h7"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.141 4.894H3.576A1.977 1.977 0 0 0 1.6 6.871v14.494c0 1.09.885 1.976 1.976 1.976h14.495a1.977 1.977 0 0 0 1.976-1.976V12.8M17.412 1.6h4.94a.99.99 0 0 1 .99.988V7.53m-10.883 4.952L23.05 1.89"></path></svg></a></li><li class="css-r6fr8v ea7mcww5"><a href="https://ctf.dontpanic.blog/notes/stack-buffer-overflow-canary.html" target="_blank" rel="noopener noreferrer">三、Security Cookie / Canary<style data-emotion-css="qic6h7">.css-qic6h7{overflow:visible;height:25px;}.css-qic6h7 *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 25 25" style="height:1rem" class="css-1dl06o9 ea7mcww0 css-qic6h7"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.141 4.894H3.576A1.977 1.977 0 0 0 1.6 6.871v14.494c0 1.09.885 1.976 1.976 1.976h14.495a1.977 1.977 0 0 0 1.976-1.976V12.8M17.412 1.6h4.94a.99.99 0 0 1 .99.988V7.53m-10.883 4.952L23.05 1.89"></path></svg></a></li></ul></div><div class="css-18f7tla ea7mcww4"><input type="checkbox" value="Erlang 快速入门" class="css-1f4tdju ea7mcww1" checked=""/><div class="css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>Erlang 快速入门</div><ul class="css-n8z9jl ea7mcww6"><li class="css-r6fr8v ea7mcww5"><a title="Introduction" href="/erlang-getting-started/1-introduction/">一、简介</a></li><li class="css-r6fr8v ea7mcww5"><a title="Sequential Programming" href="/erlang-getting-started/2-sequential-programming/">二、顺序编程</a></li></ul></div><div class="css-18f7tla ea7mcww4"><input type="checkbox" value="错误模型" class="css-1f4tdju ea7mcww1" checked=""/><div class="css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>错误模型</div><ul class="css-n8z9jl ea7mcww6"><li class="css-r6fr8v ea7mcww5"><a title="Introduction" href="/the-error-model/0-introduction/">〇、错误模型简介</a></li><li class="css-r6fr8v ea7mcww5"><a title="Ambitions and Learnings" href="/the-error-model/1-ambitions-and-learnings/">一、野心和经验</a></li><li class="css-r6fr8v ea7mcww5"><a title="Bugs Aren’t Recoverable Errors!" href="/the-error-model/2-bugs-arent-recoverable-errors/">二、Bug 不是可恢复错误！</a></li><li class="css-r6fr8v ea7mcww5"><a title="Reliability, Fault-Tolerance, and Isolation" href="/the-error-model/3-reliability-fault-tolerance-and-isolation/">三、可靠性、容错性和隔离性</a></li><li class="css-r6fr8v ea7mcww5"><a title="Bugs: Abandonment, Assertions, and Contracts" href="/the-error-model/4-bugs-abandonment-assertions-and-contracts/">四、Bugs：放弃、断言和合约</a></li><li class="css-r6fr8v ea7mcww5"><a title="Recoverable Errors: Type-Directed Exceptions" href="/the-error-model/5-ecoverable-errors-type-directed-exceptions/">五、可恢复错误：类型导向的异常</a></li><li class="css-r6fr8v ea7mcww5"><a title="Retrospective and Conclusions" href="/the-error-model/6-retrospective-and-conclusions/">六、回顾和总结</a></li></ul></div><div class="css-18f7tla ea7mcww4"><input type="checkbox" value="公共语言运行时" class="css-1f4tdju ea7mcww1" checked=""/><div class="active css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>公共语言运行时</div><ul class="css-n8z9jl ea7mcww6"><li class="css-r6fr8v ea7mcww5"><a href="/botr/1-introduction/">一、CLR 简介</a></li><li class="css-r6fr8v ea7mcww5"><a aria-current="page" class="active" href="/botr/2-garbage-collection/">二、CLR 垃圾回收器的设计</a></li><li class="css-r6fr8v ea7mcww5"><a href="/botr/6-type-loader/">六、CLR 类型加载器的设计</a></li></ul></div></div></div></aside><style data-emotion="css 1ff36h2">.css-1ff36h2{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><main class="css-1ff36h2 efh8xek6"><style data-emotion="css 1ip6okp">.css-1ip6okp{position:-webkit-sticky;position:sticky;top:0;left:0;z-index:1;}</style><header class="css-1ip6okp edldhn51"><style data-emotion="css xc8ji6">.css-xc8ji6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:0;padding:0 56px;background-color:white;}@media (max-width: 850px){.css-xc8ji6{padding:0 24px;}}</style><div class="css-xc8ji6 edldhn50"><style data-emotion="css 8jbk1d">.css-8jbk1d{display:none;}@media (max-width: 850px){.css-8jbk1d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-right:32px;color:#2F353F;}}</style><div class="css-8jbk1d efh8xek2"><style data-emotion="css 1m6zll5">.css-1m6zll5{padding:20px;margin-left:-20px;color:inherit;border:none;background:none;outline:none;cursor:pointer;}</style><button class="css-1m6zll5 e1qf1exz1"><style data-emotion="css 1ihqbbj">.css-1ihqbbj{height:24px;width:24px;display:block;fill:currentColor;}</style><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1ihqbbj e1qf1exz0 css-1a134qk"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M2.25 18.003h19.5M2.25 12.003h19.5M2.25 6.003h19.5"></path></g></svg></button></div></div></header><style data-emotion="css-global q9286l">html{scroll-padding-top:68px;}</style><style data-emotion="css ip9jqt">.css-ip9jqt{padding:40px 56px;padding-bottom:0;}@media (max-width: 850px){.css-ip9jqt{padding:32px 48px;}}@media (max-width: 600px){.css-ip9jqt{padding:24px 32px;}}</style><div class="css-ip9jqt ernxcdh2"><div class="header-wrapper"><style data-emotion="css cz947x">.css-cz947x:not(:last-child){margin-bottom:8px;}</style><h1 class="css-cz947x ei8t6h41">二、CLR 垃圾回收器的设计</h1></div><hr/><style data-emotion="css 1o129hd">.css-1o129hd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}</style><div class="css-1o129hd e694h6z7"><style data-emotion="css a181dj">.css-a181dj{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;width:0;}.css-a181dj .api-ref h4 code{font-size:1.1em;}.css-a181dj .api-ref *:not(pre)>code[class*="language-"]{padding:0;background:none;}</style><div class="css-a181dj e694h6z6"><style data-emotion="css sk9651">.css-sk9651 a[href]:not([class]){color:#2075d6;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 a[href]:not([class]):hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-sk9651 a[href]:not([class]) code{color:inherit;}.css-sk9651 h1 code,.css-sk9651 h2 code,.css-sk9651 h3 code,.css-sk9651 h4 code,.css-sk9651 h5 code,.css-sk9651 h6 code{white-space:normal;}.css-sk9651 h1 a,.css-sk9651 h2 a,.css-sk9651 h3 a,.css-sk9651 h4 a,.css-sk9651 h5 a,.css-sk9651 h6 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 h1 a:hover,.css-sk9651 h2 a:hover,.css-sk9651 h3 a:hover,.css-sk9651 h4 a:hover,.css-sk9651 h5 a:hover,.css-sk9651 h6 a:hover{color:#5A6270;}.css-sk9651 *:not(style)+ h2,.css-sk9651 *:not(style)+ h3,.css-sk9651 *:not(style)+ h4,.css-sk9651 *:not(style)+ h5{margin-top:64px;}.css-sk9651 img{display:block;max-width:100%;}.css-sk9651 .mermaid svg{max-width:100%;}</style><div class="content-wrapper css-sk9651 e694h6z5"><div><blockquote>
<p>这是一篇译文。作者：Maoni Stephens (@maoni0) - 2015<br/>
原文链接：<a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/garbage-collection.md" target="_blank" rel="noopener noreferrer">https://github.com/dotnet/coreclr/blob/master/Documentation/botr/garbage-collection.md</a></p>
</blockquote>
<p>注：请参考 The Garbage Collection Handbook 来了解更多关于垃圾回收话题的通用知识；如果希望了解关于 CLR GC 的特定知识，请参考 Pro .NET Memory Management 一书。在本文最后列出了其他可供参考的资源。</p>
<h2 id="整体结构" style="position:relative"><a class="headingLink" href="#整体结构">整体结构</a></h2>
<p>CLR GC 由两部分组成：分配器和回收器。分配器用来申请更多的内存，并在合适的时机触发垃圾回收。回收器收集内存垃圾，即程序不再使用的那些对象所占用的内存。</p>
<p>除了分配器，还有其他的途径能够触发回收器，例如手动调用 GC.Collect，或是 Finalizer 线程收到了 LowMemory 的异步通知。</p>
<h2 id="分配器的设计" style="position:relative"><a class="headingLink" href="#分配器的设计">分配器的设计</a></h2>
<p>分配器由执行引擎（Execution Engine，EE）通过一些帮助函数进行调用，会传递给分配器以下信息：</p>
<ul>
<li>申请的内存大小</li>
<li>线程分配上下文</li>
<li>标志位，例如标记这个对象是否 Finalizable</li>
</ul>
<p>分配器并不关心对象类型的信息，它只会通过 EE 得到对象的大小。基于对象大小，GC 会将对象分为两类：小对象（小于 85000 字节）和大对象（大于等于 85000 字节）。理论上来说，大对象、小对象不需要区别对待，但由于对大对象进行整理（Compact）的代价较大，因此 GC 会做出这样的区分。</p>
<p>分配器会向 GC 申请内存。GC 会以分配上下文（Allocation Context）的形式向分配器提供内存，分配上下文的大小由分配量（Allocation Quantum）决定。</p>
<ul>
<li>所谓分配上下文，是指一个堆内存段（Heap Segment）上的一小部分，将会由某个线程单独使用。在单一逻辑处理器的机器上，只会使用唯一一个上下文，作为第 0 代分配上下文。</li>
<li>所谓分配量，是指当分配器需要更多的内存来创建对象时，它每次获得的新内存空间的大小。分配量通常定义为 8k 字节，而托管对象的平均大小大约为 35 字节，这使得分配器能够在一个分配上下文中创建很多个对象。</li>
</ul>
<p>大对象不使用分配上下文和分配量，它们本身就可能要比常规的分配量大得多；同时，分配上下文的优势仅能在小对象中体现出来。因此，大对象会直接在堆内存段上申请。</p>
<p>分配器的特点包括：</p>
<ul>
<li>在合适的时机触发垃圾回收：当分配的内存大小超过一定分配额度（Allocation Budget）之后、或是分配器在一个堆内存段上没有内存可用的时候，它就会触发一次垃圾回收。关于分配额度和托管段（Managed Segment），后文还会详细介绍。</li>
<li>保持对象局部性：在同一个对内存段上的对象，它们的虚拟地址会依次相邻。</li>
<li>高效利用缓存：分配器每次会一次性申请分配量大小的内存，而不是每个对象都来申请一次内存。它会把这些缓存都清零，从而使得 CPU 能够预先缓存这块内存。</li>
<li>减少加锁需求：由于一个分配上下文和分配量只由一个线程使用，因此只要当前的分配上下文没有耗尽，就无需加锁。</li>
<li>内存完整性：GC 总是会为新对象清零内存，因此不会存在指向随机地址的对象引用。</li>
<li>保证堆内存可被爬取：分配器会保证每一个分配量中无法分配的剩余内存作为一个空闲对象（Free Object）管理。例如，如果一个分配量只剩下 30 字节的空间，但新对象需要 40 字节，那么分配器会创建一个 30 字节大小的空闲对象（译注：空闲对象会加入空闲列表中进行管理，从而不会白白浪费），同时申请一个新的分配量大小的内存来分配新的对象。</li>
</ul>
<h3 id="内存分配-api" style="position:relative"><a class="headingLink" href="#内存分配-api">内存分配 API</a></h3>
<div class="gatsby-highlight" data-language="text"><style data-emotion="css 1gcd36t">.css-1gcd36t{margin-bottom:1.45rem;border:1px solid #DEE2E7;border-radius:4px;}</style><div class="css-1gcd36t e1ulzjg73"><style data-emotion="css r8v8pb">.css-r8v8pb{padding:15px;background-color:#F4F6F8;overflow:auto;}</style><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text"> Object* GCHeap::Alloc(size_t size, DWORD flags);
 Object* GCHeap::Alloc(alloc_context* acontext, size_t size, DWORD flags);</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span></span></pre></div></div></div>
<p>大对象和小对象在分配内存均可以使用上面的函数。除此之外，大对象的分配还会使用下面这个函数：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text"> Object* GCHeap::AllocLHeap(size_t size, DWORD flags);</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
<h2 id="回收器的设计" style="position:relative"><a class="headingLink" href="#回收器的设计">回收器的设计</a></h2>
<h3 id="gc-的目标" style="position:relative"><a class="headingLink" href="#gc-的目标">GC 的目标</a></h3>
<p>GC 的目标是极度高效地管理内存，使得编写“托管代码”的人几乎不需要付出额外的成本即可受益。“高效”指的是：</p>
<ul>
<li>GC 的执行频率需要足够高。这可以避免托管堆中残留大量的无用对象（即垃圾），而导致占用过多不必要的内存。</li>
<li>GC 的执行频率需要尽量低。这可以避免浪费宝贵的 CPU 时间。</li>
<li>一次 GC 需要很有效。如果一次 GC 后几乎没有回收到内存，那么这次 GC（以及它所占用的 CPU 时间）就被浪费了。</li>
<li>每次 GC 都需要很快。很多程序有低延迟的需求。</li>
<li>托管代码的开发人员不需要知道 GC 的细节就可以享受到不错的内存使用率。也就是说，GC 应该自行调节，以便使用不同的内存使用模式。</li>
</ul>
<h3 id="托管堆的逻辑表示" style="position:relative"><a class="headingLink" href="#托管堆的逻辑表示">托管堆的逻辑表示</a></h3>
<p>CLR GC 是一个分“世代”的垃圾回收器，即对象在逻辑上会被分为不同的世代。当回收器回收了第 N 代后，仍然存活的对象将被标记为第 N + 1 代，这个过程叫做升级（Promotion）。不过，这里也存在例外，比如我们可能会考虑让某个对象不升级或者降级（demote）。</p>
<p>对于小对象来说，托管堆被分为 3 个世代：gen0、gen1 和 gen2。对于大对象来说，我们只有一个世代—— gen3。gen0 和 gen1 统称为短暂世代（Ephemeral Generations），代表着这两个世代中的对象存活时间较短。</p>
<p>小对象堆中的世代编号就代表了辈分—— gen0 是最年轻的世代。不过，这并不意味着 gen0 中的所有对象都要比 gen1 或者 gen2 中的对象更年轻，下文会提到一些例外的情况。当我们对某一个世代进行垃圾回收时，也会同时回收所有比它年轻的世代。</p>
<p>从理论上讲，大对象的处理方式也可以像小对象一样。然而，由于整理（Compact）大对象的代价比较高，因此我们将大小对象区别对待。大对象只有一个世代 gen3，考虑到性能原因，它会与 gen2 一同进行垃圾回收，因为 gen2、gen3 世代相对庞大；而短暂世代（gen0、gen1）中的对象往往生存期短，对它们进行回收时则会尽量限制性能开销。</p>
<p>分配内存时，会从最年轻的世代开始——对于小对象来说就是 gen0，大对象来说就是 gen3。</p>
<h3 id="托管堆的物理表示" style="position:relative"><a class="headingLink" href="#托管堆的物理表示">托管堆的物理表示</a></h3>
<p>托管堆由一组托管堆段组成。一个堆段是一块连续的内存，它是由 GC 向操作系统申请而得。堆段分为两种：小对象堆段和大对象堆段。在每一个堆上，堆段之间会以链式连接。一个程序的内存中至少会存在一个小对象堆段和一个大对象堆段，这两个堆段会在 CLR 启动时被默认建立。</p>
<p>在每一个小对象堆中，仅会有一个堆段用来存放 gen0 和 gen1，它叫做“短暂世代堆段”。这个堆段也可以同时用来存放 gen2。除了这个堆段之外，还可能会有一个或多个段用来存放 gen2。</p>
<p>大对象堆中也可能会有多个堆段。</p>
<p>一个堆段会以地址“从低到高”的方式进行使用，也就是说，低地址上的对象要比高地址上的对象更老。当然，下文会提到一些例外情况。</p>
<p>堆段可以按需申请。如果一个堆段不包含任何任何对象，那么它就会被删除。不过，一个堆中的初始堆段是个例外，它会始终存活。对于每个堆来说，小对象的垃圾回收、或者大对象的内存分配，都有可能会触发新的堆段申请，每次只会申请一个新堆段。这样的设计能够提供更好的性能，因为大对象会与 gen2 一同进行回收，比较耗时。</p>
<p>堆段会按照它们的申请时间依次相连。最后的堆段一定是短暂世代堆段。对于小对象堆来说，没有对象的堆段可以重复利用，作为新的短暂世代堆段。小对象在申请内存时，只会在短暂世代堆段上进行；而大对象在申请内存时，则会在整个大对象堆上进行。</p>
<h3 id="分配额度allocation-budget" style="position:relative"><a class="headingLink" href="#分配额度allocation-budget">分配额度（Allocation Budget）</a></h3>
<p>分配额度是与世代相关的一个逻辑概念，它是触发在这一世代上进行垃圾回收的阈值。这个额度的设置与这一世代的存活率有关。如果存活率较高，那么分配额度也将设置的更高，这样当下次垃圾回收时就能够回收到更多的垃圾。</p>
<h3 id="如何决定对哪一个世代进行回收" style="position:relative"><a class="headingLink" href="#如何决定对哪一个世代进行回收">如何决定对哪一个世代进行回收</a></h3>
<p>当触发了垃圾回收时，垃圾回收器要做的第一件事就是确定回收哪一个世代。除了分配额度，还有其他的因素需要考虑：</p>
<ul>
<li>世代的碎片化程度——如果一个世代的碎片化程度很高，那么在这个世代上进行垃圾回收将会更富有成效。</li>
<li>当机器的内存负载很高时，如果回收某一世代有可能能够释放内存空间，那么垃圾回收器会更加激进地进行回收。这对避免比不要的（跨机器）分页很重要。</li>
<li>如果短暂对象堆段空间不足时，垃圾回收器会更加激进地对 gen1 进行回收，来避免申请一个新的堆段。</li>
</ul>
<h2 id="垃圾回收的流程" style="position:relative"><a class="headingLink" href="#垃圾回收的流程">垃圾回收的流程</a></h2>
<h3 id="标记mark阶段" style="position:relative"><a class="headingLink" href="#标记mark阶段">标记（Mark）阶段</a></h3>
<p>标记阶段的目标是找到所有的存活对象。</p>
<p>分世代的垃圾回收器的优势之一在于，它可以只对堆中的一部分对象进行回收，而不是去一次性考虑所有的对象。当回收短暂世代时，垃圾回收器需要知道这些时代中哪些对象仍然有效。执行引擎能提供它持有的所有对象的信息；然而，更老世代中的对象也可能持有年轻世代中的对象引用。</p>
<p>垃圾回收器通过利用“卡片”（Card）标记，来更快地确定更老世代中的对象是否持有年轻世代中某个对象的引用。卡片由 JIT 帮助方法在赋值操作发生时进行设置。当 JIT 帮助方法发现一个了短暂世代中的对象被其他对象持有时，它将会设置短暂对象中相应的卡片字节以便标记引用源的大致位置。在回收短暂世代的过程中，垃圾回收器可以通过对象的卡片标记值来有选择地扫描内存，而不是把所有的内存都扫描一遍。</p>
<h3 id="计划plan阶段" style="position:relative"><a class="headingLink" href="#计划plan阶段">计划（Plan）阶段</a></h3>
<p>计划阶段模拟了一次整理（Compact）过程，用来确定对这一世代是否需要整理。如果不需要的话，垃圾回收器则会执行清扫（Sweep）。</p>
<h3 id="重定位relocate阶段" style="position:relative"><a class="headingLink" href="#重定位relocate阶段">重定位（Relocate）阶段</a></h3>
<p>如果垃圾回收器决定进行整理，那么被整理的对象的位置将会发生改变，因此必须要更新这些对象的引用。重定位阶段需要找到被回收世代中对象的所有引用。与之相比，标记阶段只需要找到那些会影响对象生命周期的引用，而不必考虑弱引用。</p>
<h3 id="整理compact阶段" style="position:relative"><a class="headingLink" href="#整理compact阶段">整理（Compact）阶段</a></h3>
<p>这个阶段比较简单。由于在计划阶段已经计算好了那些需要移动的对象的新位置，整理阶段只需要将它们拷贝到目标地址即可。</p>
<h3 id="清扫sweep阶段" style="position:relative"><a class="headingLink" href="#清扫sweep阶段">清扫（Sweep）阶段</a></h3>
<p>清扫阶段会找出那些夹在存活对象之间的垃圾空间，垃圾回收器会创建一个“自由对象”（Free Object）来占据这些空间，相邻的垃圾空间也会被合并进一个自由对象。这些自由对象会被放入自由对象列表 <code class="language-text">freelist</code> 中。</p>
<h2 id="代码流程" style="position:relative"><a class="headingLink" href="#代码流程">代码流程</a></h2>
<p>术语：</p>
<ul>
<li>WKS GC：Workstation GC</li>
<li>SVR GC：Server GC</li>
</ul>
<h3 id="各种配置下的行为" style="position:relative"><a class="headingLink" href="#各种配置下的行为">各种配置下的行为</a></h3>
<h4 id="wks-gc关闭并发-gc" style="position:relative"><a class="headingLink" href="#wks-gc关闭并发-gc">WKS GC，关闭并发 GC</a></h4>
<ol>
<li>用户线程的分配额度不足，触发了垃圾回收</li>
<li>垃圾回收器调用 <code class="language-text">SuspendEE</code> 来暂停托管线程</li>
<li>垃圾回收器决定对哪个世代进行回收</li>
<li>执行标记阶段</li>
<li>执行计划阶段，并决定是否执行整理</li>
<li>如果需要整理，那么即执行重定位阶段和整理阶段；如果不需要整理，就执行清扫阶段</li>
<li>垃圾回收器调用 <code class="language-text">RestartEE</code> 重新恢复托管线程的执行</li>
<li>用户线程继续执行</li>
</ol>
<h4 id="wks-gc开启并发-gc" style="position:relative"><a class="headingLink" href="#wks-gc开启并发-gc">WKS GC，开启并发 GC</a></h4>
<p>这一节描述了后台 GC 是如何工作的。</p>
<ol>
<li>用户线程的分配额度不足，触发了垃圾回收</li>
<li>垃圾回收器调用 <code class="language-text">SuspendEE</code> 来暂停托管线程</li>
<li>垃圾回收器决定是否需要启动后台 GC</li>
<li>如果需要的话，那么一个后台 GC 线程将被唤醒。后台 GC 线程调用 <code class="language-text">RestartEE</code> 来恢复托管线程</li>
<li>托管线程继续分配内存，于此同时后台 GC 线程仍然在进行工作</li>
<li>用户线程可能会由于分配额度不足，触发一次短暂 GC (即“前台 GC”)。短暂 GC 与上文“WKS GC，关闭并发 GC”的流程一致</li>
<li>后台 GC 再次调用 <code class="language-text">SuspendEE</code> 以便完成标记阶段，随后它会调用 <code class="language-text">RestartEE</code> 重新恢复用户线程，此时清扫阶段与用户线程并发执行</li>
<li>后台 GC 结束</li>
</ol>
<h4 id="svr-gc关闭并发-gc" style="position:relative"><a class="headingLink" href="#svr-gc关闭并发-gc">SVR GC，关闭并发 GC</a></h4>
<ol>
<li>用户线程的分配额度不足，触发了垃圾回收</li>
<li>Server GC 线程被唤醒，它们会调用 <code class="language-text">SuspendEE</code> 来暂停托管线程</li>
<li>Server GC 线程执行垃圾回收（与 WKS GC 关闭并发 GC 时的操作一致）</li>
<li>Server GC 线程调用 <code class="language-text">SuspendEE</code> 恢复托管线程</li>
<li>用户线程继续执行</li>
</ol>
<h4 id="svr-gc开启并发-gc" style="position:relative"><a class="headingLink" href="#svr-gc开启并发-gc">SVR GC，开启并发 GC</a></h4>
<p>这一场景与 WKS GC 开启并发 GC 的行为大致一致，只是后台 GC 任务是在 Server GC 线程上完成的。</p>
<h2 id="物理架构" style="position:relative"><a class="headingLink" href="#物理架构">物理架构</a></h2>
<p>这一节将有助于理解垃圾回收的代码流程。</p>
<p>用户线程的分配量不足，它会通过 <code class="language-text">try_allocate_more_space</code> 来申请新的分配量。当需要触发 GC 时，<code class="language-text">try_allocate_more_space</code> 会调用 <code class="language-text">GarbageCollectGeneration</code>。如果使用的是 WKS GC 并关闭了并发 GC，则 <code class="language-text">GarbageCollectGeneration</code> 是在用户线程上执行的。代码流程为：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">GarbageCollectGeneration()
 {
     SuspendEE();
     garbage_collect();
     RestartEE();
 }
 
 garbage_collect()
 {
     generation_to_condemn();
     gc1();
 }
 
 gc1()
 {
     mark_phase();
     plan_phase();
 }
 
 plan_phase()
 {
     // actual plan phase work to decide to 
     // compact or not
     if (compact)
     {
         relocate_phase();
         compact_phase();
     }
     else
         make_free_lists();
 }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>如果使用的是 WKS GC 并开启了并发 GC （这是默认情况），后台 GC 的代码流程为：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">GarbageCollectGeneration()
 {
     SuspendEE();
     garbage_collect();
     RestartEE();
 }
 
 garbage_collect()
 {
     generation_to_condemn();
     // decide to do a background GC
     // wake up the background GC thread to do the work
     do_background_gc();
 }
 
 do_background_gc()
 {
     init_background_gc();
     start_c_gc ();
 
     //wait until restarted by the BGC.
     wait_to_proceed();
 }
 
 bgc_thread_function()
 {
     while (1)
     {
         // wait on an event
         // wake up
         gc1();
     }
 }
 
 gc1()
 {
     background_mark_phase();
     background_sweep();
 }</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<h2 id="其他资源" style="position:relative"><a class="headingLink" href="#其他资源">其他资源</a></h2>
<ul>
<li><a href="https://raw.githubusercontent.com/dotnet/coreclr/master/src/gc/gc.cpp" target="_blank" rel="noopener noreferrer">.NET CLR GC Implementation</a></li>
<li><a href="http://www.amazon.com/Garbage-Collection-Handbook-Management-Algorithms/dp/1420082795" target="_blank" rel="noopener noreferrer">The Garbage Collection Handbook: The Art of Automatic Memory Management</a></li>
<li><a href="http://en.wikipedia.org/wiki/Garbage_collection_(computer_science)" target="_blank" rel="noopener noreferrer">Garbage collection (Wikipedia)</a></li>
<li><a href="https://prodotnetmemory.com/" target="_blank" rel="noopener noreferrer">Pro .NET Memory Management</a></li>
</ul></div></div><style data-emotion="css 1f6gfyy">.css-1f6gfyy{display:none;margin-top:48px;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}@media (max-width: 1120px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (max-width: 850px){.css-1f6gfyy{display:none;}}@media (max-width: 600px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-top:24px;}}</style><div class="css-1f6gfyy e694h6z0"></div><style data-emotion="css 9ckfit">.css-9ckfit{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:64px 0;}@media (max-width: 850px){.css-9ckfit{padding:32px 0;}}</style><nav class="css-9ckfit e1sfxy7w4"><style data-emotion="css spe9v1">.css-spe9v1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-spe9v1 svg{height:16px;width:16px;}.css-spe9v1:hover{opacity:0.8;}</style><a class="css-spe9v1 e1sfxy7w3" href="/botr/1-introduction/"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 14 24" class="css-1a134qk"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.5.75L1.78 11.47a.749.749 0 0 0-.001 1.059l.001.001L12.5 23.25"></path></svg><style data-emotion="css 16mhdhi">.css-16mhdhi{margin-left:24px;text-align:left;}@media (max-width: 850px){.css-16mhdhi{margin-left:16px;}}</style><div class="css-16mhdhi e1sfxy7w2"><style data-emotion="css 1vhhq4p">.css-1vhhq4p{letter-spacing:0.142em;text-transform:uppercase;font-size:12px;}</style><div class="css-1vhhq4p e1sfxy7w1">Previous</div><style data-emotion="css mtbysh">.css-mtbysh{color:#2F353F;}</style><div class="css-mtbysh e1sfxy7w0">一、CLR 简介</div></div></a><a style="margin-left:auto" class="css-spe9v1 e1sfxy7w3" href="/botr/6-type-loader/"><style data-emotion="css 18eg9eb">.css-18eg9eb{margin-right:24px;text-align:right;}@media (max-width: 850px){.css-18eg9eb{margin-right:16px;}}</style><div class="css-18eg9eb e1sfxy7w2"><div class="css-1vhhq4p e1sfxy7w1">Next</div><div class="css-mtbysh e1sfxy7w0">六、CLR 类型加载器的设计</div></div><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.5.75l10.72 10.72a.749.749 0 0 1 .001 1.059l-.001.001L5.5 23.25"></path></svg></a></nav><div id="comments-container"></div></div><style data-emotion="css 10vu48r">.css-10vu48r{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:240px;max-height:calc(100vh - 0px - 48px);margin-top:-36px;padding:40px 0;margin-left:40px;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 1120px){.css-10vu48r{display:none;}}@media (max-width: 850px){.css-10vu48r{display:block;}}@media (max-width: 600px){.css-10vu48r{display:none;}}</style><aside class="css-10vu48r e694h6z4"><style data-emotion="css 16ceglb">.css-16ceglb{font-weight:600;}</style><h4 class="css-16ceglb e694h6z3">二、CLR 垃圾回收器的设计</h4><style data-emotion="css gmdgof">.css-gmdgof{margin-left:0;margin-bottom:48px;overflow:auto;}</style><ul class="css-gmdgof e1wyoreh1"><style data-emotion="css 1h656g5">.css-1h656g5{list-style:none;font-size:1rem;line-height:inherit;}.css-1h656g5.active{color:#3f20ba;font-weight:bold;}.css-1h656g5 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-1h656g5 a:hover{opacity:0.8;}</style><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#整体结构">整体结构</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#分配器的设计">分配器的设计</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#内存分配-api">内存分配 API</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#回收器的设计">回收器的设计</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#gc-的目标">GC 的目标</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#托管堆的逻辑表示">托管堆的逻辑表示</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#托管堆的物理表示">托管堆的物理表示</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#分配额度allocation-budget">分配额度（Allocation Budget）</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#如何决定对哪一个世代进行回收">如何决定对哪一个世代进行回收</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#垃圾回收的流程">垃圾回收的流程</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#标记mark阶段">标记（Mark）阶段</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#计划plan阶段">计划（Plan）阶段</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#重定位relocate阶段">重定位（Relocate）阶段</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#整理compact阶段">整理（Compact）阶段</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#清扫sweep阶段">清扫（Sweep）阶段</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#代码流程">代码流程</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#各种配置下的行为">各种配置下的行为</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#wks-gc关闭并发-gc">WKS GC，关闭并发 GC</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#wks-gc开启并发-gc">WKS GC，开启并发 GC</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#svr-gc关闭并发-gc">SVR GC，关闭并发 GC</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#svr-gc开启并发-gc">SVR GC，开启并发 GC</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#物理架构">物理架构</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#其他资源">其他资源</a></li></ul></aside></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TZ8V0QY4Z8"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-TZ8V0QY4Z8', {"send_page_view":false});
      }
      </script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/botr/2-garbage-collection/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4d7916b90c2acddcaec3.js"],"app":["/app-d3467ceeff988abf002f.js"],"component---gatsby-theme-apollo-core-src-pages-404-js":["/component---gatsby-theme-apollo-core-src-pages-404-js-b66e7ee97587ae8b57e1.js"],"component---gatsby-theme-apollo-docs-src-components-template-js":["/component---gatsby-theme-apollo-docs-src-components-template-js-c0bfeb7a9d55823478d5.js"],"component---src-pages-index-mdx":["/component---src-pages-index-mdx-2ee0cebcb5cad657a921.js"],"component---src-pages-license-mdx":["/component---src-pages-license-mdx-5c19301acf098a931df1.js"]};/*]]>*/</script><script src="/polyfill-4d7916b90c2acddcaec3.js" nomodule=""></script><script src="/component---gatsby-theme-apollo-docs-src-components-template-js-c0bfeb7a9d55823478d5.js" async=""></script><script src="/app-d3467ceeff988abf002f.js" async=""></script><script src="/9f92645c-df813722f906b02fa9fd.js" async=""></script><script src="/9598fa14-6a39ed586f092d891d9f.js" async=""></script><script src="/framework-bcf4c1d2232a4f1b31b7.js" async=""></script><script src="/webpack-runtime-f03f468fb1185576d27a.js" async=""></script></body></html>