<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.78e9442d5c9415ba4bfe.css" data-identity="gatsby-global-css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}@font-face{font-family:Source Code Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcecodepro/v14/HI_SiYsKILxRpg3hIP6sJ7fM7PqlPevT.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:400;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7g.ttf) format("truetype")}@font-face{font-family:Source Sans Pro;font-style:normal;font-weight:600;src:url(https://fonts.gstatic.com/s/sourcesanspro/v14/6xKydSBYKcSV-LCoeQqfX1RYOo3i54rwlxdr.ttf) format("truetype")}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}body{font-family:Source Sans Pro,sans-serif}code,pre{font-family:Source Code Pro,monospace}html{font-size:100%;line-height:1.45;overflow-y:auto}body{color:#2f353f}div.mermaid,h1,h2,h3,h4,h5,h6,img,ol,p,ul{margin:0 0 24px}h4,h5{margin-bottom:1.0875rem}h1,h2,h3,h4,h5,h6{color:#2f353f;line-height:1.1}h1,h2,h3,h4,h6{font-weight:400}h1{font-size:2.5rem}h2{font-size:1.73286rem}h3{font-size:1.4427rem}h4{font-size:1.125rem;font-weight:700}h5,li,p{font-size:1rem}h6{font-size:.875rem}li,p{line-height:1.7}li li{font-size:1.05rem;line-height:1.4}ol,ul{margin-left:24px;padding:0}li{margin-bottom:12px}li>ol,li>ul{margin-top:12px}blockquote{border-left:2px solid #3f20ba;margin-left:0;padding:12px 20px}blockquote>ol,blockquote>p,blockquote>ul{font-size:inherit}blockquote>ol:last-child,blockquote>p:last-child,blockquote>ul:last-child{margin-bottom:0}blockquote li,td li{font-size:inherit;line-height:1.1}form{margin-bottom:0}hr{background-color:#dee2e7;border:none;height:1px;margin-bottom:23px}img.screenshot{border-radius:8px;box-shadow:0 0 0 1px rgba(18,21,26,.04),0 1px 4px 0 rgba(0,0,0,.08)}.gatsby-code-title{align-items:center;color:#5a6270;display:flex;font-family:Source Code Pro,monospace;font-size:15px;height:37px;margin-bottom:-37px;padding-left:19px}.gatsby-highlight-code-line{background-color:#ebeef0;display:block;margin-left:-3.5em;margin-right:-1em;padding-left:3.5em;padding-right:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.gatsby-highlight pre[class*=language-].line-numbers{padding-left:2.5em}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows{border-right:none}.gatsby-highlight pre[class*=language-].line-numbers .line-numbers-rows>span:before{color:#cad0d8}code[class*=language-],pre[class*=language-]{color:#2f353f;direction:ltr;font-family:Source Code Pro,monospace;font-size:15px;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:none;white-space:pre;word-break:normal;word-spacing:normal}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{background:#f4f6f8;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{background:#ebeef0;border-radius:.3em;color:#f25cc1;font-size:.9em;padding:.1em .15em}.namespace{opacity:.7}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#959daa}.token.punctuation{color:#5a6270}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#f25cc1}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#26a29d}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{background:transparent;color:inherit}.token.atrule,.token.attr-value,.token.keyword{color:#3f20ba}.token.class-name,.token.function{color:#f25cc1}.token.important,.token.regex,.token.variable{color:#f4d03f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}pre[class*=language-]>code[class*=language-],pre[data-line]{position:relative}pre[class*=language-].line-numbers{counter-reset:linenumber;padding-left:3.8em;position:relative}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{border-right:1px solid #999;font-size:100%;left:-3.8em;letter-spacing:-1px;pointer-events:none;position:absolute;top:0;-webkit-user-select:none;-ms-user-select:none;user-select:none;width:3em}.line-numbers-rows>span{counter-increment:linenumber;display:block}.line-numbers-rows>span:before{color:#999;content:counter(linenumber);display:block;padding-right:.8em;text-align:right}</style><meta name="generator" content="Gatsby 3.9.1"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">四、Bugs：放弃、断言和合约 - Tuesday.</title><link data-react-helmet="true" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Righteous"/><link data-react-helmet="true" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/><meta data-react-helmet="true" name="description" content="dontpanic 的技术专栏"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/><meta data-react-helmet="true" property="og:title" content="四、Bugs：放弃、断言和合约"/><meta data-react-helmet="true" property="og:site_name" content="Tuesday."/><meta data-react-helmet="true" property="og:description" content="Bugs: Abandonment, Assertions, and Contracts"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:title" content="四、Bugs：放弃、断言和合约"/><meta data-react-helmet="true" name="twitter:description" content="Bugs: Abandonment, Assertions, and Contracts"/><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/><link rel="icon" href="/favicon-32x32.png?v=5476ae749c7ba8c0b0961dea57fd8358" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=5476ae749c7ba8c0b0961dea57fd8358"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 48)
          }), 0)
        }
      }
    })
  </script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-93a3166f8696a3f15d1c.js"/><link as="script" rel="preload" href="/framework-709552cd5aea54a8a9c3.js"/><link as="script" rel="preload" href="/9598fa14-489b91449ca8d4391871.js"/><link as="script" rel="preload" href="/9f92645c-5ef19c6477d93ab0a1ae.js"/><link as="script" rel="preload" href="/app-ddb564b4ec49d6dcae12.js"/><link as="script" rel="preload" href="/component---gatsby-theme-apollo-docs-src-components-template-js-d7310d1e1faa1c2b839a.js"/><link as="fetch" rel="preload" href="/page-data/the-error-model/4-bugs-abandonment-assertions-and-contracts/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1511030359.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2468095761.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/809287058.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css 1ot73i">.css-1ot73i{position:-webkit-sticky;position:sticky;top:0;z-index:1;width:100%;color:#5A6270;background:#ffffff;border-width:0 0 1px 0;border-color:#DEE2E7;border-style:solid;height:48px;}</style><nav class="css-1ot73i e3whxbx6"><style data-emotion="css uv35fb">.css-uv35fb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;max-width:1440px;margin:0 auto;height:100%;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-uv35fb e3whxbx5"><style data-emotion="css la7jcn">.css-la7jcn{list-style-type:none;margin:0 12px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><ul class="css-la7jcn e3whxbx4"><style data-emotion="css x2y83o">.css-x2y83o{font-size:1rem;margin:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-x2y83o a{color:inherit;padding:4px 12px;-webkit-text-decoration:none;text-decoration:none;border-radius:4px;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;}.css-x2y83o a:hover{opacity:0.8;color:#3f20ba;background:#EBEEF0;}</style><li class="css-x2y83o e3whxbx3"><a href="/"><style data-emotion="css 1k3i00y">.css-1k3i00y{font-family:'Righteous';color:#2F353F;-webkit-background-clip:text;background-clip:text;mix-blend-mode:multiply;}</style><span class="css-1k3i00y e3whxbx1">Tuesday.</span></a></li><li class="css-x2y83o e3whxbx3"><a href="/">首页</a></li><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/" target="_blank">博客</a></li><li class="css-x2y83o e3whxbx3"><a href="https://dontpanic.blog/about" target="_blank">关于</a></li></ul><ul class="css-la7jcn e3whxbx4"><li class="css-x2y83o e3whxbx3"><a href="https://github.com/dontpanic92/tuesday" target="_blank"><style data-emotion="css vhc98e">.css-vhc98e{height:1.7rem;}</style><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github-alt" class="svg-inline--fa fa-github-alt fa-w-15 fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path fill="currentColor" d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"></path></svg></a></li><li class="css-x2y83o e3whxbx3"><a href="/license"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="info-circle" class="svg-inline--fa fa-info-circle fa-w-16 fa-fw  css-vhc98e e3whxbx2" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"></path></svg></a></li></ul></div></nav><style data-emotion="css 1h2z9rg">.css-1h2z9rg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:calc(100vh - 48px);max-width:1440px;margin:0 auto;}</style><div class="css-1h2z9rg exdt29b0"><style data-emotion="css 1226uca">.css-1226uca{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:312px;height:calc(100vh - 48px);padding:24px;overflow-y:auto;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 850px){.css-1226uca{height:100%;background-color:white;box-shadow:0 0 48px rgba(0,0,0,0.25);position:fixed;z-index:2;opacity:0;visibility:hidden;-webkit-transform:translateX(-100%);-moz-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);transition-property:transform,opacity,visibility;transition-duration:150ms;transition-timing-function:ease-in-out;}}</style><aside class="css-1226uca ezgpdot2"><style data-emotion="css 1p14ewn">.css-1p14ewn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:24px;}</style><div class="css-1p14ewn ezgpdot1"><style data-emotion="css gbkvvb">.css-gbkvvb{color:#2F353F;-webkit-text-decoration:none;text-decoration:none;}</style><a href="/" class="css-gbkvvb ezgpdot0"><style data-emotion="css 135j8ps">.css-135j8ps{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:24px;}</style><div class="css-135j8ps eetev6l1"></div></a></div><div class="sidebar"><style data-emotion="css 18y74nd">.css-18y74nd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:32px;}</style><span class="css-18y74nd efh8xek1"><style data-emotion="css n6fyyw">.css-n6fyyw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:40px;}</style><div class="css-n6fyyw e19uvsm15"><style data-emotion="css s5xdrg">.css-s5xdrg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-s5xdrg e19uvsm10"><style data-emotion="css yx4e1e">.css-yx4e1e{width:1.5rem;height:1.5rem;margin:0;}</style><img src="/avatar.png" class="css-yx4e1e e19uvsm12"/><style data-emotion="css u85vmk">.css-u85vmk{margin:0 0 0 10px;font-size:1.125rem;}</style><span class="css-u85vmk e19uvsm11">dontpanic 的技术专栏</span></div></div></span><style data-emotion="css n8z9jl">.css-n8z9jl{margin-left:36px;margin-bottom:32px;list-style:none;}</style><ul class="css-n8z9jl ea7mcww6"></ul><div><style data-emotion="css 18f7tla">.css-18f7tla{position:relative;z-index:0;}.css-18f7tla .ea7mcww6{position:relative;z-index:2;}</style><div class="css-18f7tla ea7mcww4"><style data-emotion="css 1f4tdju">.css-1f4tdju{height:100%;width:100%;cursor:pointer;position:absolute;top:0;left:0;opacity:0;z-index:1;}.css-1f4tdju:hover~.ea7mcww3{opacity:0.8;}.css-1f4tdju:not(:checked)~ .ea7mcww3 svg{-webkit-transform:rotate(-90deg);-moz-transform:rotate(-90deg);-ms-transform:rotate(-90deg);transform:rotate(-90deg);}.css-1f4tdju:not(:checked)~ .ea7mcww6{display:none;}</style><input type="checkbox" value="公共语言运行时" class="css-1f4tdju ea7mcww1" checked=""/><style data-emotion="css a7yzoi">.css-a7yzoi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:12px 0;color:#2F353F;font-weight:bold;text-transform:uppercase;}.css-a7yzoi svg{margin-right:10px;height:10px;width:10px;}.css-a7yzoi.active{color:#3f20ba;}</style><div class="css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>公共语言运行时</div><ul class="css-n8z9jl ea7mcww6"><style data-emotion="css r6fr8v">.css-r6fr8v{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:0.95rem;line-height:1.5;margin-bottom:13px;}.css-r6fr8v a{color:inherit;-webkit-text-decoration:none;text-decoration:none;padding:3px 10px;margin:-3px -10px;border-radius:4px;}.css-r6fr8v a:hover{opacity:0.8;}.css-r6fr8v a.active{color:#3f20ba;pointer-events:none;font-weight:600;background:#F4F6F8;}</style><li class="css-r6fr8v ea7mcww5"><a href="/botr/1-introduction/">一、CLR 简介</a></li><li class="css-r6fr8v ea7mcww5"><a href="/botr/2-garbage-collection/">二、CLR 垃圾回收器的设计</a></li><li class="css-r6fr8v ea7mcww5"><a href="/botr/6-type-loader/">六、CLR 类型加载器的设计</a></li></ul></div><div class="css-18f7tla ea7mcww4"><input type="checkbox" value="错误模型" class="css-1f4tdju ea7mcww1" checked=""/><div class="active css-a7yzoi ea7mcww3"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M23.25 7.311L12.53 18.03a.749.749 0 0 1-1.059.001l-.001-.001L.75 7.311"></path></svg>错误模型</div><ul class="css-n8z9jl ea7mcww6"><li class="css-r6fr8v ea7mcww5"><a title="Introduction" href="/the-error-model/0-introduction/">〇、错误模型简介</a></li><li class="css-r6fr8v ea7mcww5"><a title="Ambitions and Learnings" href="/the-error-model/1-ambitions-and-learnings/">一、野心和经验</a></li><li class="css-r6fr8v ea7mcww5"><a title="Bugs Aren’t Recoverable Errors!" href="/the-error-model/2-bugs-arent-recoverable-errors/">二、Bug 不是可恢复错误！</a></li><li class="css-r6fr8v ea7mcww5"><a title="Reliability, Fault-Tolerance, and Isolation" href="/the-error-model/3-reliability-fault-tolerance-and-isolation/">三、可靠性、容错性和隔离性</a></li><li class="css-r6fr8v ea7mcww5"><a aria-current="page" class="active" title="Bugs: Abandonment, Assertions, and Contracts" href="/the-error-model/4-bugs-abandonment-assertions-and-contracts/">四、Bugs：放弃、断言和合约</a></li><li class="css-r6fr8v ea7mcww5"><a title="Recoverable Errors: Type-Directed Exceptions" href="/the-error-model/5-ecoverable-errors-type-directed-exceptions/">五、可恢复错误：类型导向的异常</a></li><li class="css-r6fr8v ea7mcww5"><a title="Retrospective and Conclusions" href="/the-error-model/6-retrospective-and-conclusions/">六、回顾和总结</a></li></ul></div></div></div></aside><style data-emotion="css 1ff36h2">.css-1ff36h2{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><main class="css-1ff36h2 efh8xek6"><style data-emotion="css 1ip6okp">.css-1ip6okp{position:-webkit-sticky;position:sticky;top:0;left:0;z-index:1;}</style><header class="css-1ip6okp edldhn51"><style data-emotion="css xc8ji6">.css-xc8ji6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:0;padding:0 56px;background-color:white;}@media (max-width: 850px){.css-xc8ji6{padding:0 24px;}}</style><div class="css-xc8ji6 edldhn50"><style data-emotion="css 8jbk1d">.css-8jbk1d{display:none;}@media (max-width: 850px){.css-8jbk1d{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-right:32px;color:#2F353F;}}</style><div class="css-8jbk1d efh8xek2"><style data-emotion="css 1m6zll5">.css-1m6zll5{padding:20px;margin-left:-20px;color:inherit;border:none;background:none;outline:none;cursor:pointer;}</style><button class="css-1m6zll5 e1qf1exz1"><style data-emotion="css 1ihqbbj">.css-1ihqbbj{height:24px;width:24px;display:block;fill:currentColor;}</style><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1ihqbbj e1qf1exz0 css-1a134qk"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="M2.25 18.003h19.5M2.25 12.003h19.5M2.25 6.003h19.5"></path></g></svg></button></div></div></header><style data-emotion="css-global q9286l">html{scroll-padding-top:68px;}</style><style data-emotion="css ip9jqt">.css-ip9jqt{padding:40px 56px;padding-bottom:0;}@media (max-width: 850px){.css-ip9jqt{padding:32px 48px;}}@media (max-width: 600px){.css-ip9jqt{padding:24px 32px;}}</style><div class="css-ip9jqt ernxcdh2"><div class="header-wrapper"><style data-emotion="css cz947x">.css-cz947x:not(:last-child){margin-bottom:8px;}</style><h1 class="css-cz947x ei8t6h41">四、Bugs：放弃、断言和合约</h1><style data-emotion="css kfq87l">.css-kfq87l{color:#5A6270;}</style><h3 class="css-kfq87l ei8t6h40">Bugs: Abandonment, Assertions, and Contracts</h3></div><hr/><style data-emotion="css 1o129hd">.css-1o129hd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;}</style><div class="css-1o129hd e694h6z7"><style data-emotion="css a181dj">.css-a181dj{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;width:0;}.css-a181dj .api-ref h4 code{font-size:1.1em;}.css-a181dj .api-ref *:not(pre)>code[class*="language-"]{padding:0;background:none;}</style><div class="css-a181dj e694h6z6"><style data-emotion="css sk9651">.css-sk9651 a[href]:not([class]){color:#2075d6;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 a[href]:not([class]):hover{-webkit-text-decoration:underline;text-decoration:underline;}.css-sk9651 a[href]:not([class]) code{color:inherit;}.css-sk9651 h1 code,.css-sk9651 h2 code,.css-sk9651 h3 code,.css-sk9651 h4 code,.css-sk9651 h5 code,.css-sk9651 h6 code{white-space:normal;}.css-sk9651 h1 a,.css-sk9651 h2 a,.css-sk9651 h3 a,.css-sk9651 h4 a,.css-sk9651 h5 a,.css-sk9651 h6 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-sk9651 h1 a:hover,.css-sk9651 h2 a:hover,.css-sk9651 h3 a:hover,.css-sk9651 h4 a:hover,.css-sk9651 h5 a:hover,.css-sk9651 h6 a:hover{color:#5A6270;}.css-sk9651 *:not(style)+ h2,.css-sk9651 *:not(style)+ h3,.css-sk9651 *:not(style)+ h4,.css-sk9651 *:not(style)+ h5{margin-top:64px;}.css-sk9651 img{display:block;max-width:100%;}.css-sk9651 .mermaid svg{max-width:100%;}</style><div class="content-wrapper css-sk9651 e694h6z5"><div><p>在 Midori 中，很多类型的 bug 都可能会触发放弃：</p>
<ul>
<li>不正确的类型转换</li>
<li>尝试对null指针解引用</li>
<li>尝试越界访问数组</li>
<li>零除错误</li>
<li>算数计算发生意外的上溢/下溢</li>
<li>内存不足栈溢出</li>
<li>显式放弃</li>
<li>合约失败</li>
<li>断言失败</li>
</ul>
<p>我们最根本想法是，这里每一种错误都是不可恢复的。让我们逐一进行讨论。</p>
<h2 id="普通的老-bug" style="position:relative"><a class="headingLink" href="#普通的老-bug">普通的老 Bug</a></h2>
<p>上面那些情况中，有一些是公认的程序 Bug。</p>
<p>很显然，不合法的类型转换、尝试对null解引用、数组越界访问、零除错误都是程序的逻辑错误，这些都是非法操作。我们在下文会看到，这些操作也有可能被认为是合法操作（比如当一个数除以零时，也许你想要把结果表示为 NaN）；不过我们先默认假设这些就是 Bug。</p>
<p>很多程序员都会接受这个结论。使用“放弃”来应对这些 Bug，使得这些 Bug 能够在开发阶段就被快速发现、快速修正。放弃确实有助于提高写代码的生产力。一开始我还有点惊讶，但确实很有道理。</p>
<p>而另一方面，上面其他的情况是否属于 Bug，则是个主观问题。我们必须决定当出现这些状况时程序的默认行为、可能还需要提供程序化的控制方法。我们当时还为此争论不休。</p>
<h3 id="算数计算上溢下溢" style="position:relative"><a class="headingLink" href="#算数计算上溢下溢">算数计算上溢/下溢</a></h3>
<p>算数计算发生了意外的上溢/下溢究竟算不算一种 Bug，这就是一个有争议的问题。在不安全的系统里，这样的错误经常会导致安全漏洞。我建议你看看国家漏洞数据库，<a href="https://web.nvd.nist.gov/view/vuln/search-results%3Fquery%3D%2522integer%2Boverflow%2522%26search_type%3Dall%26cves%3Don" target="_blank" rel="noopener noreferrer">就能知道有多少漏洞是由这种问题导致的</a>。</p>
<p>Windows TrueType 字体的语法分析器就曾经在过去的几年里不断地受到这类问题的影响（我们把它 port 到了 Midori，还有性能提升）。语法分析器似乎是这种安全漏洞的重灾区。<a href="https://safeint.codeplex.com/" target="_blank" rel="noopener noreferrer">SafeInt</a> 因此而生，它本质上就是不让你使用语言本身提供的算术计算操作，转而使用这个库提供的受检查的计算操作。</p>
<p>当然，在这些漏洞中，大多数都跟访问不安全的内存有关。所以你可能会反驳说，溢出在一门安全的语言中没什么害处，应该被允许。然而，基于我们在安全方面的经验，通常当一个程序遇到了意外的上溢/下溢时，继续执行也不会得到正确的结果——简单来说，开发者经常会忽略可能发生的溢出，因此程序执行的结果也就无法预料。这很符合 bug 的定义，而“放弃”就是用来发现这些问题的。压死骆驼的最后一根稻草则是一个哲学问题：当我们面对任何有关正确性的问题时，我们更倾向于站在显式意图这一边。</p>
<p>因此，所有无标注的上溢、下溢都会被视为 Bug 并触发放弃。这与 C# 的 <a href="https://msdn.microsoft.com/en-us/library/h25wtyxf.aspx" target="_blank" rel="noopener noreferrer"><code class="language-text">/checked</code> 编译选项</a>很类似，只有一点不同：我们的编译器会激进地优化掉冗余的检查。（对于 C# 来说，由于很少有人用到这个开关，代码生成器不会那么激进地删掉插入的检查。）多亏了语言和编译器的协同开发，生成的代码比大多数使用 SafeInt 的 C++ 编译器产生的结果要好。跟 C# 一样，<a href="https://msdn.microsoft.com/en-us/library/khy08726.aspx" target="_blank" rel="noopener noreferrer"><code class="language-text">unchecked</code> 作用域结构</a>可以用来显式指明允许上溢或下溢。</p>
<p>大多数 C# 和 C++ 程序员第一次听到这个决定时都持反对态度。但尽管如此，我们发现，由算术溢出所触发的放弃，十次有九次都是程序 Bug。剩下的一次是在我们进行了72个小时的压力测试之后发生的——我们不断地使用浏览器、媒体播放器等软件来折磨我们的系统——然后，一些没什么危害的计数器溢出了。我觉得相比于通过压力测试来使得程序更加成熟稳定（比如死锁和竞态条件），直接提前发现问题然后修了它要有意思得多了。</p>
<h3 id="内存不足和栈溢出" style="position:relative"><a class="headingLink" href="#内存不足和栈溢出">内存不足和栈溢出</a></h3>
<p>内存不足（Out-of-Memory，OOM）的情况有点复杂。我们的方法在这当然也是有争议的。</p>
<p>在内存需要手动管理的情况下，错误码风格是最常见的检查方式：</p>
<div class="gatsby-highlight" data-language="c"><style data-emotion="css 1gcd36t">.css-1gcd36t{margin-bottom:1.45rem;border:1px solid #DEE2E7;border-radius:4px;}</style><div class="css-1gcd36t e1ulzjg73"><style data-emotion="css 1y4makq">.css-1y4makq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;padding:4px;border-bottom:1px solid #DEE2E7;}</style><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><style data-emotion="css r8v8pb">.css-r8v8pb{padding:15px;background-color:#F4F6F8;overflow:auto;}</style><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c">X<span class="token operator">*</span> x <span class="token operator">=</span> <span class="token punctuation">(</span>X<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理内存申请失败</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这种方式有一个很微妙的好处：内存分配很痛苦、需要思考，因此使用这种技术的程序通常更加节俭、谨慎地使用内存。但这种方式有一个巨大的不足：它极易出错、同时会产生大量的没有经过测试的代码路径（code path）。如果一条代码路径没有被测试过，那么它很容易出问题。</p>
<p>当内存快要不够的时候，开发人员所采取的措施通常都不够妥当。以我在 Windows 和 .Net Framework 上的经验来看，这就是犯下严重错误的地方，衍生出了极其复杂的编程模型，比如 .Net 中所谓的受限执行区域（Constrained Execution Regions）。一个程序一瘸一拐，连一小块内存都拿不到，很快就会成为可靠性的敌人。<a href="https://blogs.msdn.com/b/cbrumme/archive/2003/06/23/51482.aspx" target="_blank" rel="noopener noreferrer">Chris Brumme 的一篇非常赞的文章</a>讲述了与其有关的故事。</p>
<p>我们的系统中有一些部分比较难搞，比如在内核的底层，放弃的范围肯定要比单一进程更大。不过我们在尽可能地控制这种代码的规模。系统中的其他部分呢？没错，你肯定猜到了——放弃。优雅而又简洁。</p>
<p>令人惊讶的是，这种方法似乎并没有带来太多的麻烦，我把大部分原因归功于隔离模型。实际上，根据资源管理的策略的设置，我们也可以有意地让使一个进程“内存不足”进而触发放弃，以此来证明整个系统的健壮性和可恢复性。</p>
<p>当某一次内存申请失败时，你也可以选择不触发放弃。这其实不太常见，但我们也有机制来支持这种选择。可能最合适的例子是：假如你的程序这一次想要申请 1MB 的内存。这跟平时小于 1KB 的对象内存申请不太一样，开发人员可能会提前考虑到内存不够的情况并作出充分的准备。比如：</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">var bb = try new byte[1024*1024] else catch;
if (bb.Failed) {
    // 处理内存申请失败
}</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>栈溢出是这个思路的简单延伸。实际上，由于我们的“异步链接栈”（asynchronous linked stacks）模型，栈内存不足在物理上就等同于堆内存不足，因此处理方法与 OOM 一致也并不令人惊讶。如今很多系统都用这样的方式来处理栈溢出。</p>
<h2 id="断言" style="position:relative"><a class="headingLink" href="#断言">断言</a></h2>
<p>断言是指在代码中手动检查某些条件必须为真，否则就会触发放弃。与很多系统一样，我们的系统中断言也分为两种：仅在 Debug 模式下的断言和 Release 模式下的断言。然而不同的是，我们使用 Release 断言的时候更多。实际上，断言在我们的代码里随处可见，大多数的方法都有不止一个断言。</p>
<p>这种实践符合这样的哲学：当运行时遇到 bug 时，把它暴露出来要比继续执行更好。当然，我们的编译器后端知道如何激进地对这些断言进行优化。我们的代码中断言的密度很高，与很多高可靠系统所建议的很类似，比如在 NASA 的论文 <a href="https://pixelscommander.com/wp-content/uploads/2014/12/P10.pdf" target="_blank" rel="noopener noreferrer">The Power of Ten -Rules for Developing Safety Critical Code</a> 中：</p>
<blockquote>
<p>规则：代码中断言的密度至少为每个函数2个。断言用来检查在真正执行时不应该发生的反常现象。断言必须没有副作用，应当定义为布尔值检测。<br/>
原因：根据工业界编码工作的统计数据，通常每编写10行到100行代码，单元测试就能发现一个缺陷。发现缺陷的机率随着断言密度的增加而增长。断言也通常作为强防御编码策略（strong defensive coding strategy）所建议的一部分。</p>
</blockquote>
<p>如果想要插入断言，只需要简单地调用 <code class="language-text">Debug.Assert</code> 或是 <code class="language-text">Release.Assert</code>：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Debug<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>something<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Debug-only assert.</span>
    Release<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span>something<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Always-checked assert.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>我们同样实现了与 C++ 中 <code class="language-text">__FILE__</code> 和 <code class="language-text">__LINE__</code> 宏类似的功能，外加 <code class="language-text">__EXPR__</code>，代表了断言中谓语表达式的文本。这样的话由于失败断言而导致的放弃将会包含一些有用的信息。</p>
<p>在早些时候，我们设计了与现在不同的断言“等级”。一共三级，<code class="language-text">Contract.Strong.Assert</code>、<code class="language-text">Contract.Assert</code>、<code class="language-text">Contract.Weak.Assert</code>。最强的等级表示“始终检查”，中间的等级表示“编译器说了算”、最弱的等级表示“仅在 Debug 模式下检查”。我做了一个很有争议的决定——抛弃这种模型。实际上，我非常肯定，我们组里 49.99% 的人都讨厌我对术语的选择（<code class="language-text">Debug.Assert</code> 和<code class="language-text">Release.Assert</code>），但我始终都觉得这两个词很恰当，它们完美地表明了这两种断言究竟在做什么。旧的分类方法的问题在于，没有人确切地知道什么时候应该检查断言；在我看来，由于好的断言准则对于程序的可靠性极其重要，而断言的使用方法居然会令人困惑，这是我无法接受的。</p>
<p>在我们把合约（contracts）添加到语言中之后（下文很快就会介绍），我们也尝试过把 <code class="language-text">assert</code> 设计为一个关键字。不过，最终我们还是继续使用了 API 的方式。主要的原因是，与合约不同，断言不是 API 签名（signature）的一部分；同时由于断言很容易以库的形式实现，我们也不确定把它加入到语言当中有什么好处；还有一点，“Debug 模式下的检查”和“Release 模式下的检查”之类的策略，看着就不像一门编程语言应该有的东西。我得承认，就算这么多年过去了，我还是不太确定哪种方式更好一些。</p>
<h2 id="合约" style="position:relative"><a class="headingLink" href="#合约">合约</a></h2>
<p>合约是在 Midori 中发现 Bug 的最核心的机制，没有之一。我们是从 <a href="https://en.wikipedia.org/wiki/Singularity_%28operating_system%29" target="_blank" rel="noopener noreferrer">Singularity</a> 开始做起的，它使用的是 Sing#，一门 <a href="https://research.microsoft.com/en-us/projects/specsharp/" target="_blank" rel="noopener noreferrer">Spec#</a> 的变种语言。不过我们很快就换成使用正规的 C# 了，只能把我们想要的东西重新发明一遍。最终我们实现的模型跟最初的模型已经相去甚远。</p>
<p>多亏了我们的语言对不变性和副作用的理解，所有的合约和断言都被证明了是没有副作用的。这大概是这门语言最大的创新点，我肯定会再写一篇博客讲讲它的。</p>
<p>跟其他方面一样，我们也受到了很多其它系统的影响。Spec# 是最明显的一个。<a href="https://files.ifi.uzh.ch/rerg/amadeus/teaching/courses/ase_fs10/Meyer1992.pdf" target="_blank" rel="noopener noreferrer">Eiffel 也对我们有很大的影响</a>，尤其是有很多公开发表的研究。另外还有一些其他的研究工作也对我们有所帮助，例如基于 Ada 的 <a href="https://en.wikipedia.org/wiki/SPARK_%28programming_language%29" target="_blank" rel="noopener noreferrer">SPARK</a>、一些实时与嵌入式系统的提议等等。更深入地讲，像<a href="https://www.spatial.maine.edu/~worboys/processes/hoare%2520axiomatic.pdf" target="_blank" rel="noopener noreferrer">霍尔公理语义</a>这样的编程逻辑为所有的一切提供了基础。然而对我来说，最重要的哲学启发来自于 CLU、以及之后的 <a href="https://pdos.csail.mit.edu/archive/6.824-2009/papers/argus88.pdf" target="_blank" rel="noopener noreferrer">Argus</a> 中提供的错误处理方法。</p>
<h3 id="前置条件和后置条件（preconditions-and-postconditions）" style="position:relative"><a class="headingLink" href="#前置条件和后置条件（preconditions-and-postconditions）">前置条件和后置条件（Preconditions and Postconditions）</a></h3>
<p>合约最基本的形式就是方法的前置条件，它声明了要调用这个方法所必须满足的条件。通常来说先决条件会用来验证参数。它有时也会用来验证目标对象的状态，不过这非常少见，因为对于程序员来说考虑清楚模态（modality）是一件很困难的事。前置条件基本上就是调用者对被调用者做出的承诺。</p>
<p>在我们最终的模型中，前置条件使用 <code class="language-text">requires</code> 关键字声明：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">)</span>
    requires <span class="token operator">!</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsEmpty</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 继续执行，字符串一定不为空</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>一种稍微不太常见的合约就是方法的后置条件。它声明了在这个方法调用之后应有的状态。这是被调用者对调用者做出的承诺。</p>
<p>在我们最终的模型中，后置条件使用 <code class="language-text">ensures</code> 关键字声明：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token class-name">ensures</span> Count <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token comment">// 继续执行，调用者明确知道在方法返回时Count一定0</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>在后置条件中，同样可以通过特殊的名字 <code class="language-text">return</code> 来引用返回值。旧值——比如在后置条件中需要引用输入的时候——可以通过 <code class="language-text">old(...)</code> 来得到。例如：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">AddOne</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span>
    ensures <span class="token keyword">return</span> <span class="token operator">==</span> <span class="token function">old</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>当然，前置条件和后置条件可以一起混用。例如，在 Midori 内核中的环形缓冲区的实现里：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">PublishPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token class-name">requires</span> RemainingSize <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token class-name">ensures</span> UnpublishedSize <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这个方法的函数体在执行时可以确信 <code class="language-text">RemainingSize</code> 一定为 <code class="language-text">0</code>，调用者在调用之后也可以确信 <code class="language-text">UnpublishedSize</code> 也一定为 <code class="language-text">0</code>。</p>
<p>在运行时，任何一个合约没有被满足时，都将会触发放弃。</p>
<p>在这个领域，我们的方法跟其他人的工作有点不同。最近，合约在一些高级证明技术中的程序逻辑中作为一种表达式越来越流行，这些工具工厂使用全局分析来证明声明的的合约是否为真。我们也采用了类似的方法，但合约默认是在运行时检查的。如果编译器在编译期能够证明真假，那么它也可以不生成运行时检查的代码，或是抛出一个编译错误。</p>
<p>现代的编译器都有基于约束的分析，在这方面做得很好，例如我上篇博客中提到的<a href="https://en.wikipedia.org/wiki/Value_range_analysis" target="_blank" rel="noopener noreferrer">范围分析</a>。它们通过传递事实信息（facts）来对代码进行优化，例如消除冗余的检查：既包括显式声明的合约，也包括普通的程序逻辑。它们也能在合理的时间内完成这些分析，这样程序员才不会觉得太慢转而使用别的编译器。定理证明技术所支持的代码规模满足不了我们的需要。最好的定理证明分析框架花了整整一天来分析我们的核心系统模块！</p>
<p>进一步来说，方法所声明的合约是它签名的一部分。这就意味着这些合约会自动显示在文档里、IDE 的代码提示里，等等。合约就跟方法的参数类型、返回类型一样重要。合约其实就是类型系统的扩展，使用语言所能表达的任何逻辑来对类型交换（exchange types）加以控制。因此，所有常见的对子类型的要求都适用于合约。同样，这也有助于模块化局部分析，使用标准优化的编译器技术能够在几秒钟之内完成。</p>
<p>.NET 和 Java 中大约 90% 的异常都能够使用前置条件替代，包括所有的<code class="language-text">ArgumentNullException</code>、<code class="language-text">ArgumentOutOfRangeException</code> 以及相关的类型。更重要的是，我们不再需要手动检查之后再 <code class="language-text">throw</code> 了。如今很多 C# 代码中四处可见这样的检查，仅在 .NET 的 CoreFX 仓库中就有上千个。例如，下面是 <code class="language-text">System.IO.TextReader</code> 中的 <code class="language-text">Read</code> 方法：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// ...</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;Thrown if buffer is null.&lt;/exception&gt;</span>
<span class="token comment">/// &lt;exception cref=&quot;ArgumentOutOfRangeException&quot;&gt;Thrown if index is less than zero.&lt;/exception&gt;</span>
<span class="token comment">/// &lt;exception cref=&quot;ArgumentOutOfRangeException&quot;&gt;Thrown if count is less than zero.&lt;/exception&gt;</span>
<span class="token comment">/// &lt;exception cref=&quot;ArgumentException&quot;&gt;Thrown if index and count are outside of buffer&#x27;s bounds.&lt;/exception&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>Length <span class="token operator">-</span> index <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这样的写法不太好，原因有很多。显而易见的是它太冗长了，除此之外似乎没什么不好——然而，我们需要在文档中提及所有可能抛出异常，这似乎在提醒开发人员，这些异常需要被捕获。但这些异常真的不应该被捕获，相反，它们应该在开发阶段就发现这些 bug 然后修掉。</p>
<p>另一方面，如果我们使用 Midori 风格的合约，则这些代码可以简化为：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// ...</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
    requires buffer <span class="token operator">!=</span> <span class="token keyword">null</span>
    requires index <span class="token operator">&gt;=</span> <span class="token number">0</span>
    requires count <span class="token operator">&gt;=</span> <span class="token number">0</span>
    requires buffer<span class="token punctuation">.</span>Length <span class="token operator">-</span> index <span class="token operator">&gt;=</span> count <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这段代码有很多地方值得一说。首先，它更简洁，更重要的是，它以一种文档化的方式描述了这个 API 的合约，调用者也更容易理解。相比于使用用于来描述这些错误条件，调用者还可以直接查看表达式，相关工具也更容易理解和利用这些条件。最后，当合约检查失败时，它会触发放弃。</p>
<p>同样值得一说的是，我们提供了非常多的合约帮助方法，以便能够更方便地实现一些常见的前置条件。上述的显式范围检查同样非常啰嗦，容易出错。我们可以改写为：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
    requires buffer <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token return-type class-name">requires</span> Range<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> count<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>说句有点偏题的，如果结合两个高级功能——数组切片和非空类型——我们能够进一步简化代码，同时提供了相同的承诺：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div></div></div>
<p>还是让我们从头开始讲吧…</p>
<h2 id="谦卑的开始" style="position:relative"><a class="headingLink" href="#谦卑的开始">谦卑的开始</a></h2>
<p>虽然我们最终的语法很像 Eiffel 和 Spec#，但就像我前面提到的，我们一开始并没有想改变语言本身。因此我们从 API 开始：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">PublishPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Contract<span class="token punctuation">.</span><span class="token function">Requires</span><span class="token punctuation">(</span>RemainingSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Contract<span class="token punctuation">.</span><span class="token function">Ensures</span><span class="token punctuation">(</span>UnpublishedSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>这种方法有很多问题，就像 <a href="https://research.microsoft.com/en-us/projects/contracts/" target="_blank" rel="noopener noreferrer">.NET Code Contracts</a> 所遇到的一样。</p>
<p>首先，这种方式实现的合约属于 API <em>实现</em> 的一部分，然而我们希望它成为 API <em>签名</em> 的一部分。这似乎只是理论上的问题，但其实不是。我们希望生成的程序包含一些内置的元数据，从而像 IDE、调试器之类的工具能够在函数调用时把合约显示出来。我们也希望文档工具能够根据合约自动生成文档。把合约埋在实现当中无法实现这些功能，除非你知道如何反汇编这些函数然后再把这些信息提取出来（然而这是一种hack）。这也让合约与编译器后端的整合更加困难，生成高性能的代码需要这些信息。</p>
<p>其次，你可能会注意到对 <code class="language-text">Contract.Ensures</code> 的调用。<code class="language-text">Ensures</code> 需要在函数的每一个返回点调用，我们如何只使用 API 来实现呢？答案是：确实不能。一种方法是在编译器生成 MSIL 后，对 MSIL 进行重写，但这很麻烦。看到这你也许回想，为什么我们不能简单地承认这是一个语言的表达能力和予以的问题，然后加上专门的语法呢？</p>
<p>另一方面，一个长期举棋不定的问题是合约是否允许根据编译模式的不同而不同。很多经典的系统中，Debug 模式会检查合约，但完全优化的版本不会。在很长一段时间里，我们有三种不同级别的合约，就像我们之前提到的断言一样：</p>
<ul>
<li>Weak，声明为 <code class="language-text">Contract.Weak.*</code>，表示仅在 Debug 模式开启</li>
<li>Normal，声明为 <code class="language-text">Contract.*</code>，表示由具体实现来决定什么时候检查合约</li>
<li>Strong，声明为 <code class="language-text">Contract.Strong.*</code>，表示始终检查。</li>
</ul>
<p>我得承认，一开始我觉得这种方案非常优雅。然而不幸的是，始终都有人对“Normal”合约存在疑惑，它们会在 Debug 还是 Release 模式下开启？开始两者都会开启？（也因此大家也都用错了 Weak 和 Strong。）不管怎样，我们开始把这种合约模式整合进语言，以及编译器后端工具链。而此时，问题开始不断出现。我们不得不做出一些妥协。</p>
<p>首先就是，如果你简单的把 <code class="language-text">Contract.Weak.Requires</code> 翻译为 <code class="language-text">weak requires</code>、把 <code class="language-text">Contract.Strong.Requires</code> 翻译为 <code class="language-text">strong requires</code>，你会的到一种相当笨拙而又不够普适的语法，过多可选的策略也让我不舒服。这就直接引出了 <code class="language-text">weak/strong</code> 策略的参数化和可替换性。</p>
<p>其次，这种方法引入了一种新的条件编译模式，对我而言有点不爽。换句话说，如果你想要只在 Debug 模式下检查，已经有语法来实现了：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span>
    requires X
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div></div></div>
<p>最后——对我而言这是压死骆驼的最后一根稻草——合约应该是 API 签名的一部分。条件编译一个合约是几个意思？相关工具应该怎么看待 API 签名？需要为 Debug 和 Release 模式产生不同的文档吗？更进一步，如果我们真的采取了这种方式，你就失去了严格的保证——即如果前置条件不满足，你的代码就不会运行。</p>
<p>最后，我们修改了整个条件编译的方案。</p>
<p>我们最终只采用了一种合约：它是 API 签名的一部分，并且始终检查。如果一个编译器在编译阶段就能够证明合约成立（我们花了很大的精力在这个方面），那么可以省略这些检查。我们始终都能够保证前置条件不满足的话就不执行代码。任何需要条件检查的情况，都可以使用上面提到的断言系统。</p>
<p>在部署了这个新的模型之后，我跟高兴曾经误用了“weak”和“strong”的人都不再困惑了。强迫开发人员做出决定，有助于提高代码的质量。</p>
<h2 id="未来的方向" style="position:relative"><a class="headingLink" href="#未来的方向">未来的方向</a></h2>
<p>当我们的项目结束的时候，很多领域都已经不同程度地有所成熟。</p>
<h3 id="不变量（invariants）" style="position:relative"><a class="headingLink" href="#不变量（invariants）">不变量（Invariants）</a></h3>
<p>我们对不变量做了大量的尝试。每次我跟精通合约设计的人讨论问题的时候，他们对我们没有从一开始就使用不变量感到惊讶。老师说，我们的设计的确一开始就包括了这些内容，但我们没能有足够的时间来实现和部署这一功能。部分原因是工程人力的不足，但同时也是由于存在一些难以解决的问题。同时，团队几乎对前置条件、后置条件和断言非常满意。我甚至怀疑，随着时间的推移，我们已经完整实现了不变量，但如今仍有一些问题困扰着我。我得再多看一看它在实践中的应用。</p>
<p>我们的设计所提供的方法是，<code class="language-text">invaraint</code> 是类型内部的一个成员。例如：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">List<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">;</span>
    <span class="token keyword">private</span> invariant index <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>需要注意的是 <code class="language-text">invariant</code> 标记为了 <code class="language-text">private</code>。一个不变量的访问控制符表明了这个不变量需要检查的成员。例如，一个 <code class="language-text">public invaraint</code> 只需要对 <code class="language-text">public</code> 函数的入口和出口做出限制。这使得一些 <code class="language-text">private</code> 函数能够临时的破坏不变量，只要其在 <code class="language-text">public</code> 的入口和出口处仍然成立即可，这也是一种常见的模式。当然，就像上面的例子一样，一个类也可以声明一个 <code class="language-text">private invariant</code>，这就要求所有的函数在进入和退出时都要满足不变量的条件。</p>
<p>我非常喜欢这种设计，我也认为它能够实现。一个主要的忧虑是我们在所有的地方都引入了一个隐式的检查。就算在今天，这也让我有点不安。例如在 <code class="language-text">List&lt;T&gt;</code> 的例子中，这个类中的每一个函数的开始和结束的地方都需要插入 <code class="language-text">index &gt;= 0 &amp;&amp; index &lt; array.Length</code> 的检查。我们的编译器最终能够很好的识别并合并冗余的合约检查，并且在很多情况下合约都能够 <em>显著</em> 提高代码的质量。然而，在上面给出的极端例子中，我确信性能上会有所影响。这迫使我们考虑换一种不变量的检查策略，而这可能会使得整个合约模型变得复杂。</p>
<p>我真的希望我们能够有更多的时间，来更深入地探索不变量。我们的团队似乎并没有对这个功能非常期待——至少我们没有听到过抱怨没有不变量的声音（也许是因为整个团队特别看重性能问题）——但我确定的是，不变量肯定会为合约系统增色不少。</p>
<h3 id="高级类型系统" style="position:relative"><a class="headingLink" href="#高级类型系统">高级类型系统</a></h3>
<p>我喜欢这种说法：合约是类型系统的补充。类型系统让你能够使用类型来对变量的属性进行定义，例如类型可以限制一个变量的值的范围。合约同样可以检查变量的值的范围。那么区别在哪呢？在编译时，严格的、可组合的归纳规则确保了类型的正确性。在检查局部的函数时，这些规则通常不会太耗时，同时还会有开发人员提供的标注作为帮助（不过也可能没有）。而合约则是：尽可能的在编译期证明合约的正确性，如果证明不了的话，就在运行时检查。因此，合约不提供严格的规范，允许使用语言本身提供的任意逻辑进行声明。</p>
<p>类型总是首选，因为它们能够在编译期就提供保证，而且保证能够做到快速地检查。这种为开发人员提供的强有力的保证，有助于提高开发人员整体的生产力。</p>
<p>然而，类型系统不可避免地有一些限制；类型系统需要留出一定的回旋的余地，否则它们就会变得非常难用。极端的情况下，类型系统甚至会退化至位/字节级别的规定。即便如此，有两点“回旋的余地”始终让我很不爽，使得我们必须使用合约来解决：</p>
<ol>
<li>是否可为空</li>
<li>数值范围</li>
</ol>
<p>大约 90% 的合约会落入这两点当中。结果就是，我们认真探索了更加复杂的类型系统，以便能够使用类型系统（而不是合约）来判别是否为空、以及变量值的范围。</p>
<p>具体来说，下面这段代码使用了合约：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
    requires buffer <span class="token operator">!=</span> <span class="token keyword">null</span>
    requires index <span class="token operator">&gt;=</span> <span class="token number">0</span>
    requires count <span class="token operator">&gt;=</span> <span class="token number">0</span>
    requires buffer<span class="token punctuation">.</span>Length <span class="token operator">-</span> index <span class="token operator">&lt;</span> count <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>而下面这段代码则不需要，只利用编译期的静态检查就能够得到同样的保证：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Read</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div></div></div>
<p>将这些属性放入类型系统能够大幅度减轻错误检查的负担。举个例子，对于某个状态来说，它有 1 个生产者、10 个消费者。与其在 10 个消费者那里对状态进行检查，我们可以做到把检查放到生产者那里——比如加上一句强制的类型断言，或者更好的做法是一开始就把值存进正确的类型中。</p>
<h3 id="非空类型" style="position:relative"><a class="headingLink" href="#非空类型">非空类型</a></h3>
<p>第一点其实有点难办：静态地保证一个变量不会为 <code class="language-text">null</code> 值。这就是 Tony Hoare （译注：就是上文提到的 C. Hoare）所说的著名的“<a href="https://www.infoq.com/presentations/Null-References-The-Billion-Dollar-Mistake-Tony-Hoare" target="_blank" rel="noopener noreferrer">billion dollar mistake</a>”。对任何语言来说，想办法解决这个问题都是一个非常合理的目标。现在很多新语言的设计师都决定直面这个问题，我非常高兴。</p>
<p>一门语言的很多方面都会阻碍我们实现这一特性，泛型、零值初始化、构造函数，等等。把非空类型添加进一门现有的语言真的很难！</p>
<h4 id="类型系统" style="position:relative"><a class="headingLink" href="#类型系统">类型系统</a></h4>
<p>简单来说，非空类型可以简单归纳为类型系统的一些规则：</p>
<ol>
<li>所有不加装饰的类型 <code class="language-text">T</code> 默认都是非空的</li>
<li>所有添加了 <code class="language-text">?</code> 的类型，例如 <code class="language-text">T?</code>，都是可空的</li>
<li>对于非空类型来说，<code class="language-text">null</code> 是不合法的值</li>
<li><code class="language-text">T</code> 能够隐式转换为 <code class="language-text">T?</code>。换句话说，<code class="language-text">T</code> 是 <code class="language-text">T?</code> 的一个子类型（尽管不完全对）</li>
<li>存在从 <code class="language-text">T?</code> 到 <code class="language-text">T</code> 的显式转换，运行时需要检查是否为空，如果为空则触发放弃</li>
</ol>
<p>这其中的大部分似乎都“显而易见”，我们没有太多的选择。根据类型名称的不同，类型系统能够知道 <code class="language-text">null</code> 的所有路径。具体来说，一个 <code class="language-text">null</code> 永远不能偷偷地变成一个非空类型 <code class="language-text">T</code>；这就意味着我们需要零值初始化，也许这才是所有问题当中最难的一个。</p>
<h4 id="语法" style="position:relative"><a class="headingLink" href="#语法">语法</a></h4>
<p>我们提供了几种将 <code class="language-text">T?</code> 转换为 <code class="language-text">T</code> 的语法，用来实现第 5 条规则。当然，我们不建议做这种转换，而是更希望你能够尽可能地使用非空的类型。但有时候确实是需要做转换的。多阶段初始化很常见，尤其是容器类的数据结构，因此还是需要支持这种转换。</p>
<p>考虑一下，假如我们有一个 map：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token class-name">Map<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Customer<span class="token punctuation">&gt;</span></span> customers <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
<p>这一句构造语句告诉我们：</p>
<ol>
<li>Map 自身不为 <code class="language-text">null</code></li>
<li>Map 当中的 <code class="language-text">int</code> 键不会为 <code class="language-text">null</code></li>
<li>Map 当中的 <code class="language-text">Customer</code> 值也不会为 <code class="language-text">null</code></li>
</ol>
<p>假设我们在索引函数中，使用 <code class="language-text">null</code> 来表示某个键不存在的情况：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name">TValue<span class="token punctuation">?</span></span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token class-name">TKey</span> key<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div></div></div>
<p>那么现在我们需要在调用处检查一下索引是否成功。我们讨论了很多种语法。</p>
<p>最简单的方法是加上一个检查来做保护：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token class-name">Customer<span class="token punctuation">?</span></span> customer <span class="token operator">=</span> customers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此处的 `customer` 变为非空类型 `Customer`</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>我承认，我总是对神奇的隐式转换持怀疑态度。当出现问题的时候，很难发现到底是哪里不对。例如，当你试图将 <code class="language-text">c</code>（译注：应为 <code class="language-text">customer</code>）跟一个值为 <code class="language-text">null</code> 的变量进行比较的时候，就会出现问题。不过，这种语法很好记，而且通常情况下都没问题。</p>
<p>当值确实为 <code class="language-text">null</code> 时，这种语法就会执行另一条分支。但有时你只是像简单地做一次断言，如果值为空则触发放弃。显式类型断言操作符能够实现这样的操作：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token class-name">Customer<span class="token punctuation">?</span></span> maybeCustomer <span class="token operator">=</span> customers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token keyword">notnull</span><span class="token punctuation">(</span>maybeCustomer<span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span></span></pre></div></div></div>
<p><code class="language-text">notnull</code> 操作符将任意的 <code class="language-text">T?</code> 类型的表达式转换为 <code class="language-text">T</code> 类型。</p>
<h4 id="泛型" style="position:relative"><a class="headingLink" href="#泛型">泛型</a></h4>
<p>泛型有点复杂，因为有多级的可空性需要考虑。考虑下面的代码：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">M</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">T<span class="token punctuation">?</span></span> <span class="token generic-method"><span class="token function">N</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name"><span class="token keyword">var</span></span> a <span class="token operator">=</span> C<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">M</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> b <span class="token operator">=</span> C<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">M</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> c <span class="token operator">=</span> C<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">N</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> d <span class="token operator">=</span> C<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">N</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>一个很基本的问题是：<code class="language-text">a</code>、<code class="language-text">b</code>、<code class="language-text">c</code> 和 <code class="language-text">d</code> 的类型是什么？</p>
<p>一开始我们走了点弯路，主要是因为我们当时在模仿 C# 中的 <code class="language-text">nullable</code>，但其实 C# 的 <code class="language-text">nullable</code> 有点特别。好消息是，我们最终找到了自己的方法，虽然花了点时间。举个例子来说明我想表达的意思，关于这个问题的答案，现在有两大阵营：</p>
<ul>
<li>.NET 阵营：<code class="language-text">a</code> 是 <code class="language-text">object</code>；<code class="language-text">b</code>、<code class="language-text">c</code> 和 <code class="language-text">d</code> 是 <code class="language-text">object?</code></li>
<li>函数式语言阵营：<code class="language-text">a</code> 是 <code class="language-text">object</code>；<code class="language-text">b</code> 和 <code class="language-text">c</code> 是 <code class="language-text">object?</code>；<code class="language-text">d</code> 是 <code class="language-text">object??</code></li>
</ul>
<p>换句话说，.NET 阵营认为你应该把所有的 <code class="language-text">?</code> 压缩成一个。而理解了数学组合之美的函数式阵营，则选择不使用任何神奇的操作，让这个世界该怎么样就怎么样。我们最终意识到，.NET 的方法出奇的复杂，同时还需要运行时支持。</p>
<p>函数式语言的方法确实会让人一时摸不着头脑。例如，前面举的 map 的例子：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token class-name">Map<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> Customer<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> customers <span class="token operator">=</span> <span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
Customer<span class="token operator">??</span> customer <span class="token operator">=</span> customers<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 请注意, `customer` 在此处为 `Customer?`，仍然可能为 `null`！</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>在这个模型中，每次只能剥掉一次 <code class="language-text">?</code>。但说实话，如果停下来想想，就会发现这其实很有道理。它更加透明，准确地表达了究竟发生了什么事。我们最好不要逆势而为。</p>
<p>此外，在实现上还有问题需要考虑。最简单的实现方法是把 <code class="language-text">T?</code> 扩展为某些“wrapper”类型，比如<code class="language-text">Maybe&lt;T&gt;</code>，然后插入合适的 <code class="language-text">wrap</code> 和 <code class="language-text">unwrap</code> 操作。确实，这似乎是一个合理的实现方法。但有这个模型存在两点问题。</p>
<p>第一点问题是，对于引用类型 <code class="language-text">T</code> 来说，<code class="language-text">T?</code> 不能浪费不必要的空间——一个指针的运行时表示已经能够包括 <code class="language-text">null</code> 了。作为一门系统语言，我们希望能把 <code class="language-text">T?</code> 和 <code class="language-text">T</code> 实现得一样高效。这可以简单地通过特化泛型的实例化来解决。但这意味着非空类型不再只是简单的前端问题，变为需要编译器后端支持。（需要注意的是，这种解决方案难以扩展至 <code class="language-text">T??</code>）</p>
<p>第二点是， 由于有可变型（Mutability）的标注，Midori 支持安全协变（safe covariant）数组。如果 <code class="language-text">T和T?</code> 有着不同的物理表示，那么从 <code class="language-text">T[]</code> 到 <code class="language-text">T?[]</code> 就不是一种转换操作了。这其实只是个小瑕疵，特别是当你堵住了协变数组的安全漏洞之后，协变数组就不再那么有用了。</p>
<p>不管怎样，我们最后放弃了 .NET <code class="language-text">Nullable&lt;T&gt;</code> 这条路，转而使用了组合性更强的多个 <code class="language-text">?</code> 的设计。</p>
<h4 id="零值初始化" style="position:relative"><a class="headingLink" href="#零值初始化">零值初始化</a></h4>
<p>零值初始化是一个真正的难题。它需要：</p>
<ul>
<li>一个类的所有非空域（field）都需要在构造时初始化</li>
<li>一个非空类型的数组中的所有成员需要在构造时全部初始化</li>
</ul>
<p>但这还不是最糟糕的。在 .NET 中，所有的值类型（value types）都是隐式零值初始化的。因此最基本的规则就是:</p>
<div class="gatsby-highlight" data-language="text"><div class="css-1gcd36t e1ulzjg73"><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">一个 struct 的所有域必须是可空的</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span></span></pre></div></div></div>
<p>绝望的气息。这几乎把整个系统都污染了。我的假设是，只有当可空类型不常用时（比如 20% 的使用率），不可空性才会真正有用。这条规则立刻就毁了一切。</p>
<p>所以我们开始了去除自动零值初始化的工作，工作量非常大。（C# 6 则选择了允许 struct 提供自己的零值初始化构造函数，<a href="https://github.com/dotnet/roslyn/issues/1029" target="_blank" rel="noopener noreferrer">但由于对整个生态系统的影响太大而不得不放弃</a>。）非空类型本来是能够成功的，但我们有点偏离了跑道、分了心，进而引出了别的问题。如果我能再重来一次，我只需要将 C# 中的值类型和引用类型统一起来就够了。在我下一篇文章——垃圾回收的斗争之路中，这方面的原因将会有更清楚的解释。</p>
<h4 id="非空类型的命运" style="position:relative"><a class="headingLink" href="#非空类型的命运">非空类型的命运</a></h4>
<p>我们有坚实的设计、实现了几个原型，但从来没有在整个操作系统层面部署这个功能。原因与我们所期望的 C# 兼容性有关。公平地说，我在这件事上犹豫了很久，最终就做出了这样的决定。在 Midori 的早期，我们希望人们一见到它就觉得很熟悉；后来，我们甚至在考虑，是不是所有的功能都能够作为 C# 的附加扩展来实现。正是这种想法阻碍了非空类型的实现。如今我相信，仅仅添加一些标注是无法成功的——Spec# 已经这么尝试过了！而且空和非空的默认选择应该倒过来——非空值必须得是默认实现，它才能够达到我们想要的效果。</p>
<p>我最大的遗憾之一就是没能尽早着手非空类型的工作。我们在开始大规模应用合约之后才开始非空类型的探索——因为我们发现代码中充斥着成千上万个 <code class="language-text">requires x != null</code>。虽然它很复杂、代价很高，但如果同时把去除值类型也实现的话，它们俩绝对是个超赞的组合。真的是要活到老学到老啊！</p>
<p>如果我们把我们的语言从 C# 独立出来单独发布，我相信我们能做的更好。</p>
<h3 id="范围类型" style="position:relative"><a class="headingLink" href="#范围类型">范围类型</a></h3>
<p>我们设计过向 C# 中添加范围类型，但它的复杂度总是刚好高过我能接受的程度。</p>
<p>基本的想法是，每一个数值类型都可以接受一个下界类型参数和一个上界类型参数。例如，你能够表达出一个整型只能存放 0 到 1000000 之间的整数。例如声明为 <code class="language-text">int&lt;0..1000000&gt;</code>。当然，这其实代表你应该使用一个 <code class="language-text">uint</code>，编译器应该能够给出警告。实际上，所有的整型都可以根据这个概念进行表示：</p>
<div class="gatsby-highlight" data-language="c"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-c line-numbers"><code class="language-c"><span class="token keyword">typedef</span> byte number<span class="token operator">&lt;</span><span class="token number">0.</span><span class="token number">.256</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> sbyte number<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">128.</span><span class="token number">.128</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">short</span> number<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">32768.</span><span class="token number">.32768</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> ushort number<span class="token operator">&lt;</span><span class="token number">0.</span><span class="token number">.65536</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span> number<span class="token operator">&lt;</span><span class="token operator">-</span><span class="token number">2147483648.</span><span class="token number">.2147483648</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> uint number<span class="token operator">&lt;</span><span class="token number">0.</span><span class="token number">.4294967295</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>真正帅爆了（但同时极度复杂）的是，我们可以进而使用依赖类型来允许符号范围参数。例如，我有一个数组，并且希望传入的索引能够保证在某个范围之内。通常来说我会写：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name">T</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">)</span>
        requires index <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>Length <span class="token punctuation">{</span>
    <span class="token keyword">return</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>或者我可以使用 <code class="language-text">uint</code> 来替代前半部分的检查：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name">T</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">uint</span></span> index<span class="token punctuation">)</span>
        index <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>Length <span class="token punctuation">{</span>
    <span class="token keyword">return</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div></div></div>
<p>如果有了范围类型，我就可以把索引的上界跟数组的长度直接绑定起来：</p>
<div class="gatsby-highlight" data-language="csharp"><div class="css-1gcd36t e1ulzjg73"><div class="css-1y4makq e1ulzjg72"><style data-emotion-css="1knuq0t">.css-1knuq0t{background-color:transparent;border-radius:4px;border-width:0;color:#424855;cursor:pointer;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:28px;min-width:76px;padding-left:12px;padding-right:12px;font-family:'Source Sans Pro',sans-serif;font-size:13px;line-height:1.54;font-weight:600;outline:0;-webkit-text-decoration:none;text-decoration:none;white-space:nowrap;}.css-1knuq0t:focus{outline:0;}.css-1knuq0t:hover,.css-1knuq0t[data-force-hover-state]{background-color:#F4F6F8;color:#424855;}.css-1knuq0t[data-force-focus-state]{background-color:#ffffff;color:#2075d6;box-shadow:0 1px 4px 0 rgba(18,21,26,0.08),0 0 0 2px #bbdbff,inset 0 0 0 1px #2075d6,inset 0 -1px 0 0 rgba(18,21,26,0.05);}.css-1knuq0t:active,.css-1knuq0t[data-force-active-state],.css-1knuq0t[aria-expanded=true]{color:#424855;background-color:#EBEEF0;box-shadow:none;outline:0;}</style><button class="css-1knuq0t">Copy</button></div><div class="css-r8v8pb e1ulzjg70"><pre style="counter-reset:linenumber NaN" class="language-csharp line-numbers"><code class="language-csharp"><span class="token return-type class-name">T</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> array<span class="token punctuation">,</span> <span class="token class-name">number<span class="token punctuation">&lt;</span>0<span class="token punctuation">,</span> array<span class="token punctuation">.</span>Length<span class="token punctuation">&gt;</span></span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div></div></div>
<p>当然，如果你破坏了编译器的别名检查，边界检查可能就会在运行时进行了。但我们希望至少它能跟合约检查的代价相当。必须要承认，这种方法就是对类型系统中的信息进行更直接的操作。</p>
<p>不管怎样，我还是觉得这个主意太酷了。不过它仍然是“有它更好，没有也不强求”的那一类功能。“不强求”的原因在于，在我们的类型系统中，切片（slice）是一等公民。我打赌，在三分之二甚至更多的情况下，切片是比范围检查更合适的写法。我认为大多数人还是习惯于使用范围检查，因此他们还是写出了标准的 C# 写法，而不是使用切片。我会在之后的文章中介绍切片，在大多数情况下，它确实能够替代范围检查。</p></div></div><style data-emotion="css 1f6gfyy">.css-1f6gfyy{display:none;margin-top:48px;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}@media (max-width: 1120px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (max-width: 850px){.css-1f6gfyy{display:none;}}@media (max-width: 600px){.css-1f6gfyy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-top:24px;}}</style><div class="css-1f6gfyy e694h6z0"></div><style data-emotion="css 9ckfit">.css-9ckfit{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;padding:64px 0;}@media (max-width: 850px){.css-9ckfit{padding:32px 0;}}</style><nav class="css-9ckfit e1sfxy7w4"><style data-emotion="css spe9v1">.css-spe9v1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-spe9v1 svg{height:16px;width:16px;}.css-spe9v1:hover{opacity:0.8;}</style><a class="css-spe9v1 e1sfxy7w3" href="/the-error-model/3-reliability-fault-tolerance-and-isolation/"><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 14 24" class="css-1a134qk"><path fill="none" fill-rule="evenodd" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12.5.75L1.78 11.47a.749.749 0 0 0-.001 1.059l.001.001L12.5 23.25"></path></svg><style data-emotion="css 16mhdhi">.css-16mhdhi{margin-left:24px;text-align:left;}@media (max-width: 850px){.css-16mhdhi{margin-left:16px;}}</style><div class="css-16mhdhi e1sfxy7w2"><style data-emotion="css 1vhhq4p">.css-1vhhq4p{letter-spacing:0.142em;text-transform:uppercase;font-size:12px;}</style><div class="css-1vhhq4p e1sfxy7w1">Previous</div><style data-emotion="css mtbysh">.css-mtbysh{color:#2F353F;}</style><div class="css-mtbysh e1sfxy7w0">三、可靠性、容错性和隔离性</div></div></a><a style="margin-left:auto" class="css-spe9v1 e1sfxy7w3" href="/the-error-model/5-ecoverable-errors-type-directed-exceptions/"><style data-emotion="css 18eg9eb">.css-18eg9eb{margin-right:24px;text-align:right;}@media (max-width: 850px){.css-18eg9eb{margin-right:16px;}}</style><div class="css-18eg9eb e1sfxy7w2"><div class="css-1vhhq4p e1sfxy7w1">Next</div><div class="css-mtbysh e1sfxy7w0">五、可恢复错误：类型导向的异常</div></div><style data-emotion-css="1a134qk">.css-1a134qk{overflow:visible;height:24px;}.css-1a134qk *{vector-effect:non-scaling-stroke;}</style><svg viewBox="0 0 24 24" class="css-1a134qk"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5.5.75l10.72 10.72a.749.749 0 0 1 .001 1.059l-.001.001L5.5 23.25"></path></svg></a></nav><div id="comments-container"></div></div><style data-emotion="css 10vu48r">.css-10vu48r{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:240px;max-height:calc(100vh - 0px - 48px);margin-top:-36px;padding:40px 0;margin-left:40px;position:-webkit-sticky;position:sticky;top:48px;}@media (max-width: 1120px){.css-10vu48r{display:none;}}@media (max-width: 850px){.css-10vu48r{display:block;}}@media (max-width: 600px){.css-10vu48r{display:none;}}</style><aside class="css-10vu48r e694h6z4"><style data-emotion="css 16ceglb">.css-16ceglb{font-weight:600;}</style><h4 class="css-16ceglb e694h6z3">四、Bugs：放弃、断言和合约</h4><style data-emotion="css gmdgof">.css-gmdgof{margin-left:0;margin-bottom:48px;overflow:auto;}</style><ul class="css-gmdgof e1wyoreh1"><style data-emotion="css 1h656g5">.css-1h656g5{list-style:none;font-size:1rem;line-height:inherit;}.css-1h656g5.active{color:#3f20ba;font-weight:bold;}.css-1h656g5 a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}.css-1h656g5 a:hover{opacity:0.8;}</style><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#普通的老-bug">普通的老 Bug</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#算数计算上溢下溢">算数计算上溢/下溢</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#内存不足和栈溢出">内存不足和栈溢出</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#断言">断言</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#合约">合约</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#前置条件和后置条件（preconditions-and-postconditions）">前置条件和后置条件（Preconditions and Postconditions）</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#谦卑的开始">谦卑的开始</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:16px"><a href="#未来的方向">未来的方向</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#不变量（invariants）">不变量（Invariants）</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#高级类型系统">高级类型系统</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#非空类型">非空类型</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#类型系统">类型系统</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#语法">语法</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#泛型">泛型</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#零值初始化">零值初始化</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:48px"><a href="#非空类型的命运">非空类型的命运</a></li><li class=" css-1h656g5 e1wyoreh0" style="padding-left:32px"><a href="#范围类型">范围类型</a></li></ul></aside></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-TZ8V0QY4Z8"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-TZ8V0QY4Z8', {"send_page_view":false});
      }
      </script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/the-error-model/4-bugs-abandonment-assertions-and-contracts/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-6e0f68151e061361b855.js"],"app":["/app-ddb564b4ec49d6dcae12.js"],"component---gatsby-theme-apollo-core-src-pages-404-js":["/component---gatsby-theme-apollo-core-src-pages-404-js-fe929beb924e2cdddf9c.js"],"component---gatsby-theme-apollo-docs-src-components-template-js":["/component---gatsby-theme-apollo-docs-src-components-template-js-d7310d1e1faa1c2b839a.js"],"component---src-pages-index-mdx":["/component---src-pages-index-mdx-5ab88f128cd21fbf35a6.js"],"component---src-pages-license-mdx":["/component---src-pages-license-mdx-b7ef07ead0f0018ea135.js"]};/*]]>*/</script><script src="/polyfill-6e0f68151e061361b855.js" nomodule=""></script><script src="/component---gatsby-theme-apollo-docs-src-components-template-js-d7310d1e1faa1c2b839a.js" async=""></script><script src="/app-ddb564b4ec49d6dcae12.js" async=""></script><script src="/9f92645c-5ef19c6477d93ab0a1ae.js" async=""></script><script src="/9598fa14-489b91449ca8d4391871.js" async=""></script><script src="/framework-709552cd5aea54a8a9c3.js" async=""></script><script src="/webpack-runtime-93a3166f8696a3f15d1c.js" async=""></script></body></html>