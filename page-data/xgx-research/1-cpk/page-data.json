{
    "componentChunkName": "component---gatsby-theme-apollo-docs-src-components-template-js",
    "path": "/xgx-research/1-cpk/",
    "result": {"data":{"site":{"pathPrefix":"","siteMetadata":{"title":"Tuesday.","description":"dontpanic 的技术专栏"}},"file":{"sourceInstanceName":"content","childMarkdownRemark":{"frontmatter":{"title":"一、打包格式 CPK","description":"CPK Packaging Format","featuredImage":null},"headings":[{"value":"概述","depth":2},{"value":"文件格式描述","depth":2},{"value":"CPK 文件头 CpkHeader","depth":3},{"value":"节点表 CpkTable","depth":3}],"fields":{"image":"","apiReference":false},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"h2","properties":{"id":"概述","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E6%A6%82%E8%BF%B0","ariaLabel":"概述 permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"概述"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"CPK 是仙剑三、仙剑三外传和仙剑四使用的打包格式。CPK 打包格式支持保留完整的目录结构，支持文件压缩。仙剑三所使用的 CPK 打包文件没有任何的加密措施，而仙剑四则加入了简易的加密方式。CPK 文件整体格式如下："}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"内容"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"类型"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"CPK 文件头"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"CpkHeader"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"节点表"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"CpkTable"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"文件数据"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"..."}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"其中 CPK 文件头中包含了 CPK 文件的元信息，诸如版本、文件节点数量、文件数量、节点表起始位置、文件数据其实位置等等。节点表中包含了所有节点的元信息，每个目录和文件都是节点表中的一项，它描述了文件数据的起始位置、文件的原始大小、压缩后大小、父节点、文件路径的 CRC32 值等等。值得一提的是文件路径的 CRC32 值是节点的唯一标识符，在节点表中也会使用父目录的路径 CRC32 值指定父节点。需要注意的是，CRC32 算法在 CRC 多项式表以及异或方式上有很多变种，在仙剑中的具体计算方式参见 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/dontpanic92/OpenPAL3/blob/master/yaobow/shared/src/fs/cpk/crc.rs"},"children":[{"type":"text","value":"crc.rs"}]},{"type":"text","value":"。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"虽然 CPK 文件保留了目录结构，但是在游戏读取文件时，并不会真的生成层次化的目录结构，而是通过计算文件完整路径的 CRC32 值后查表得到对应的文件节点。例如，当游戏需要读取一个 CPK 文件包中的 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"musiuc\\P01.mp3"}]},{"type":"text","value":" 文件时，首先会对字符串 \"music\\P01.mp3\" 计算 CRC32 值，随后在节点表中查找该 CRC32 值对应的文件节点，从而得到文件的起始位置和大小。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"CPK 文件可能会存在被加密的部分，可以通过文件头中的 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"data_start"}]},{"type":"text","value":" 字段的值是否为 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"0x00100080"}]},{"type":"text","value":" 来判断。如果存在加密部分，则自 CPK 文件头之后的 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"0x1000"}]},{"type":"text","value":" 个字节采用 xxtea 算法加密，解密密钥为字符串 \"Vampire.C.J at Softstar Technology (ShangHai) Co., Ltd\"。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"妖弓源文件"}]},{"type":"text","value":"："},{"type":"element","tagName":"a","properties":{"href":"https://github.com/dontpanic92/OpenPAL3/blob/master/yaobow/shared/src/fs/cpk/cpk_archive.rs"},"children":[{"type":"text","value":"https://github.com/dontpanic92/OpenPAL3/blob/master/yaobow/shared/src/fs/cpk/cpk_archive.rs"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"文件格式描述","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%8F%8F%E8%BF%B0","ariaLabel":"文件格式描述 permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"文件格式描述"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"cpk-文件头-cpkheader","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#cpk-%E6%96%87%E4%BB%B6%E5%A4%B4-cpkheader","ariaLabel":"cpk 文件头 cpkheader permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"CPK 文件头 CpkHeader"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"字段"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"类型"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"label"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"table_start"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"data_start"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"max_file_num"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"file_num"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"is_formatted"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"size_of_header"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"valid_table_num"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"max_table_num"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"fragment_num"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"package_size"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"reserved"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"[u32; 20]"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{"id":"节点表-cpktable","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E8%8A%82%E7%82%B9%E8%A1%A8-cpktable","ariaLabel":"节点表 cpktable permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"节点表 CpkTable"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"字段"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"类型"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"说明"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"crc"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"文件路径的 CRC32 值"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"flag"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"father_crc"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"父节点路径的 CRC32 值"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"start_pos"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"文件数据起始位置"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"packed_size"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"压缩后大小"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"origin_size"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"原始大小"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"extra_info_size"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"u32"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"用于存放额外数据，例如文件名"}]}]}]}]}],"data":{"quirksMode":false}}},"childMdx":null}},"pageContext":{"id":"9189b1ad-a44c-589f-ac20-d32a7453067b","versionDifference":0,"versionBasePath":"/v2","sidebarContents":[{"title":null,"pages":[]},{"title":"山海狂心：仙古轩系列游戏逆向研究","pages":[{"title":"〇、前言","sidebarTitle":"","description":"Preface","path":"/xgx-research/0-preface/"},{"title":"一、打包格式 CPK","sidebarTitle":"","description":"CPK Packaging Format","path":"/xgx-research/1-cpk/"},{"title":"二、打包格式 FMB","sidebarTitle":"","description":"FMB Packaging Format","path":"/xgx-research/2-fmb/"}]},{"title":"栈缓冲区溢出 101","pages":[{"anchor":true,"title":"一、栈缓冲区溢出 101","path":"https://ctf.dontpanic.blog/notes/stack-buffer-overflow-101.html"},{"anchor":true,"title":"二、ASLR","path":"https://ctf.dontpanic.blog/notes/stack-buffer-overflow-aslr.html"},{"anchor":true,"title":"三、Security Cookie / Canary","path":"https://ctf.dontpanic.blog/notes/stack-buffer-overflow-canary.html"}]},{"title":"错误模型","pages":[{"title":"〇、错误模型简介","sidebarTitle":"","description":"Introduction","path":"/the-error-model/0-introduction/"},{"title":"一、野心和经验","sidebarTitle":"","description":"Ambitions and Learnings","path":"/the-error-model/1-ambitions-and-learnings/"},{"title":"二、Bug 不是可恢复错误！","sidebarTitle":"","description":"Bugs Aren’t Recoverable Errors!","path":"/the-error-model/2-bugs-arent-recoverable-errors/"},{"title":"三、可靠性、容错性和隔离性","sidebarTitle":"","description":"Reliability, Fault-Tolerance, and Isolation","path":"/the-error-model/3-reliability-fault-tolerance-and-isolation/"},{"title":"四、Bugs：放弃、断言和合约","sidebarTitle":"","description":"Bugs: Abandonment, Assertions, and Contracts","path":"/the-error-model/4-bugs-abandonment-assertions-and-contracts/"},{"title":"五、可恢复错误：类型导向的异常","sidebarTitle":"","description":"Recoverable Errors: Type-Directed Exceptions","path":"/the-error-model/5-ecoverable-errors-type-directed-exceptions/"},{"title":"六、回顾和总结","sidebarTitle":"","description":"Retrospective and Conclusions","path":"/the-error-model/6-retrospective-and-conclusions/"}]},{"title":"公共语言运行时","pages":[{"title":"一、CLR 简介","sidebarTitle":"","description":null,"path":"/botr/1-introduction/"},{"title":"二、CLR 垃圾回收器的设计","sidebarTitle":"","description":null,"path":"/botr/2-garbage-collection/"},{"title":"六、CLR 类型加载器的设计","sidebarTitle":"","description":null,"path":"/botr/6-type-loader/"}]}],"versions":[],"defaultVersion":"2"}},
    "staticQueryHashes": ["1511030359","2468095761","4121983877"]}